# 备份覆盖复测报告（第二轮）

日期：2026-02-27

## 1. 复测结果

已通过：
- `pnpm --filter ./packages/core test`（39/39）
- `pnpm --filter ./packages/cli build`
- `node --check packages/aicoding/bin/aicoding.js`

未通过（仓库现有类型问题，与本次备份逻辑无关）：
- `pnpm --filter ./packages/core build`
- `pnpm --filter ./packages/desktop type-check`

共同错误特征：`OPENCLAW` 在类型常量中缺失，导致编译报错。

## 2. 本轮已补齐的备份覆盖

1. fail-closed 统一错误提示
- `packages/core/src/utils/file.ts` 新增 `backupFileOrThrow`

2. Core 主链路
- ToolManager 保存前备份
- Codex/Claude/Gemini/OpenCode/OpenClaw/MCP writer 写前备份
- `ccman config.json`（sync 配置）写前备份
- `claude-clean` 中单条删除/清空项目历史写前备份

3. Desktop
- `write-config-files`、`write-ccman-config-files`：写前备份、备份失败中止、写入失败回滚
- 写入改为 `tmp + rename` 原子落盘

4. ai-coding
- OpenCode/OpenClaw 补齐写前备份
- 统一 fail-closed 提示

5. backup 文件权限
- `backupConfig`（sync merge）新增 `chmod 600`

## 3. 仍未完全覆盖备份的点位（最新）

### P1（建议后续补齐）

1. 迁移模块的写入策略仍不统一（`migrate.ts`）
- `migrateConfig` 中 `codex.json/claude.json` 写入为直接写；旧 `config.json` 在后续才重命名为 `.bak`
- 若中途失败可能产生“部分新文件 + 旧文件未迁移”的中间态

2. `migrateV2ToV3` 写 `claude.json` 未走统一备份封装
- 当前逻辑依赖“目标不存在”前置条件，风险较低，但风格不一致

### P2（策略一致性）

3. `export` 命令对目标目录属于“用户指定输出目录”
- 本轮已补：目标文件存在时先备份再覆盖
- 但与核心配置目录策略仍有命名差异（`.bak` vs `.backup.<ts>`）

## 4. 功能正常性结论

在当前可执行的测试和构建范围内：
- 核心行为正常（core 全测通过）
- CLI 构建正常
- ai-coding 脚本语法正常

阻塞“全量构建通过”的剩余问题是仓库原有类型定义不一致（OpenClaw 常量缺失），不是本次备份 fail-closed 改动引入。
