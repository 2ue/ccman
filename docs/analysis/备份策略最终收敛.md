# 备份策略最终收敛（2026-02-27）

## 最终规则

1. 仅在“改写用户外部工具配置”场景执行备份。
2. `.ccman` 目录下配置写入默认不备份。
3. 外部工具 `switch/use` 触发的写入默认不备份。
4. 需要备份的场景采用 `fail-closed`：
   - 备份失败时立即中止后续写入。
   - 抛出明确提示：`备份失败，已中止后续写入（...）`。

## 覆盖矩阵

### 需要备份（保留）

- `desktop` 手动编辑外部工具配置：`write-config-files`
- `aicoding` 写入外部工具配置（Codex/OpenCode/OpenClaw）
- `core` 导出覆盖目标文件：`exportConfig`（目标文件已存在时）
- `core` 导入/同步高风险流程：
  - `importConfig`
  - `sync` 下载/合并（`backupConfig` 路径）
- `core` 破坏性清理流程：`claude-clean`

### 不需要备份（已去除）

- `.ccman` 常规配置写入：
  - `core/config.ts` 的 `saveConfig`
  - `tool-manager` 的 `saveConfig`（`codex.json/claude.json/...`）
  - `mcp` 的 `saveMCPConfig`
  - `desktop` 的 `write-ccman-config-files`
- 外部工具 `switch/use` 触发写入：
  - `writers/codex.ts`
  - `writers/claude.ts`
  - `writers/gemini.ts`
  - `writers/opencode.ts`
  - `writers/openclaw.ts`
  - `writers/mcp.ts`（写入 app 配置）

## 设计取舍

- 收益：避免“切换工具时频繁生成备份”的噪音与磁盘堆积。
- 风险：`switch/use` 误写时缺少本地 `.bak` 快照。
- 缓解：保留导入/同步/手动编辑/清理等高风险路径的备份与回滚。
