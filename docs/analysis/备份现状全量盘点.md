# ccman 备份现状全量盘点（CLI / Desktop / ai-coding）

## 1. 目标与范围

本文档落地当前项目中“会写入配置文件”的所有主要链路，判断是否具备“写前备份”，并明确缺口位置。

范围包含：
- `packages/core`
- `packages/cli`
- `packages/desktop`
- `packages/aicoding`

## 2. 总体结论

当前项目还未实现“所有写操作都先落盘备份”。

已覆盖备份的核心场景：
- Codex 官方配置写入（`config.toml`、`auth.json`）
- Sync 下载/合并（备份 `~/.ccman/*.json`）
- Import 导入（备份被覆盖的 `~/.ccman/*.json`）
- Claude clean 的部分操作（整体验证清理、删项目、删缓存）

主要缺口：
- ToolManager 对 `~/.ccman/*.json` 的增删改切换均无备份
- Claude/Gemini/OpenCode/OpenClaw/MCP writer 写官方配置前无备份
- Desktop 的“配置编辑器写入”仅做内存回滚，不生成备份文件
- `clean:delete-history-entry`、`clean:clear-project-history` 不备份
- ai-coding 仅 Codex 有备份，OpenCode/OpenClaw 无备份
- sync 配置 `~/.ccman/config.json` 写入无备份

## 3. 已有备份能力（现状）

### 3.1 Codex writer（已备份）

- 备份 `config.toml`：`packages/core/src/writers/codex.ts:214`
- 备份 `auth.json`：`packages/core/src/writers/codex.ts:258`

说明：当前实现是“备份失败也继续写”。若要求“必须有备份”，此处仍需收紧策略。

### 3.2 Sync download/merge（已备份）

- download 备份：`packages/core/src/sync/sync-v2.ts:195`
- merge 备份：`packages/core/src/sync/sync-v2.ts:336`
- 备份实现：`packages/core/src/sync/merge.ts:21`

### 3.3 Import（已备份）

- 导入前备份：`packages/core/src/export.ts:184`

### 3.4 Claude clean 的部分操作（已备份）

- 统一清理：`packages/core/src/claude-clean.ts:154`
- 删除项目：`packages/core/src/claude-clean.ts:335`
- 删除缓存：`packages/core/src/claude-clean.ts:368`

## 4. 备份缺口清单（按优先级）

## P0（高风险，优先修）

1. ToolManager 全写操作无备份（影响 CLI + Desktop 主流程）
- 保存入口：`packages/core/src/tool-manager.ts:202`
- 具体写入调用：`...:268`, `...:311`, `...:362`, `...:390`, `...:428`, `...:464`, `...:532`, `...:556`

2. 官方配置 writer 普遍无备份（除 Codex）
- Claude：`packages/core/src/writers/claude.ts:134`
- Gemini：`packages/core/src/writers/gemini.ts:214`, `...:149`
- OpenCode：`packages/core/src/writers/opencode.ts:229`
- OpenClaw：`packages/core/src/writers/openclaw.ts:326`, `...:327`
- MCP：`packages/core/src/writers/mcp.ts:251`, `...:99`

3. Desktop 配置编辑器写入不落盘备份
- `write-config-files`：`packages/desktop/src/main/index.ts:864`
- `write-ccman-config-files`：`packages/desktop/src/main/index.ts:970`

## P1（中风险）

4. `~/.ccman/config.json`（sync 配置）无备份
- `packages/core/src/config.ts:56`

5. clean 的两类操作明确“不备份”
- `deleteHistoryEntry`：`packages/core/src/claude-clean.ts:406`
- `clearProjectHistory`：`packages/core/src/claude-clean.ts:434`

6. ai-coding 对 OpenCode/OpenClaw 写入前不备份
- OpenCode 写入：`packages/aicoding/bin/aicoding.js:303`
- OpenClaw 写入：`packages/aicoding/bin/aicoding.js:380`, `...:381`

## P2（一致性与可运维）

7. Import 支持文件集不完整
- 当前仅：`codex.json`, `claude.json`, `openclaw.json`
- 位置：`packages/core/src/export.ts:17`
- 若目标是“所有命令一致备份/恢复”，建议纳入 `gemini.json`, `opencode.json`, `mcp.json`, `config.json`

## 5. 命令维度映射（是否应具备备份）

应具备“写前备份”的命令/动作：
- `ccman cx/cc/gm/oc/openclaw add|edit|remove|clone|use`
- `ccman mcp add|edit|remove` 以及 Desktop `mcp:toggle-app`
- `ccman gmn`
- `ccman import`
- `ccman sync download|merge`
- Desktop 里的“编辑配置文件并保存”
- Desktop/CLI 的 clean 写操作（包括删除单条、清空项目）
- `@2ue/aicoding` 的所有写动作（Codex/OpenCode/OpenClaw）

可不备份（只读）：
- `list/current/status/test/analyze/export/read-config`

## 6. 补充观察

- 当前 `writeJSON` 仅保证原子写，不等于“可恢复备份”：`packages/core/src/utils/file.ts:24`
- 目前有两种备份命名：`.bak` 与 `.backup.<timestamp>`，策略不统一。
- Desktop 编辑器的“回滚”只对本次进程有效，无法作为用户可追溯备份。
