# ccman 现有功能总结

> 基于 2025-12-07 代码分析，面向用户的功能清单
>
> **目标：** 重构后必须保留所有现有功能，确保零回退

---

## 一、支持的工具

### 1.1 主工具（Service Provider 管理）
- **Codex** - OpenAI 系代码助手
- **Claude Code** - Anthropic 系代码助手
- **Gemini CLI** - Google 系代码助手

### 1.2 辅助工具
- **MCP** (Model Context Protocol) - 服务器管理，支持 Claude 和 Gemini
- **ccman** - 配置管理工具自身

---

## 二、核心功能

### 2.1 服务商（Provider）管理

所有主工具（Codex / Claude / Gemini）均支持以下操作：

| 功能 | CLI 命令 | 说明 |
|------|---------|------|
| **添加** | `ccman cx/cc/gm add` | 添加新服务商配置 |
| **列表** | `ccman cx/cc/gm list` | 查看所有服务商 |
| **切换** | `ccman cx/cc/gm use <id>` | 切换当前使用的服务商 |
| **当前** | `ccman cx/cc/gm current` | 查看当前激活的服务商 |
| **编辑** | `ccman cx/cc/gm edit <id>` | 修改服务商配置 |
| **删除** | `ccman cx/cc/gm remove <id>` | 删除服务商 |
| **克隆** | `ccman cx/cc/gm clone <id>` | 克隆服务商（用于多 Key 管理）|

**配置存储位置：**
- ccman 内部：`~/.ccman/<tool>.json`（存储服务商列表、当前选中、预设等）
- 工具官方配置：
  - Codex: `~/.codex/config.toml` + `~/.codex/auth.json`
  - Claude: `~/.claude/settings.json`
  - Gemini: `~/.gemini/settings.json` + `~/.gemini/.env`

### 2.2 MCP 服务器管理

| 功能 | CLI 命令 | 说明 |
|------|---------|------|
| **添加** | `ccman mcp add` | 添加 MCP 服务器 |
| **列表** | `ccman mcp list` | 查看所有 MCP 服务器 |
| **编辑** | `ccman mcp edit <name>` | 修改 MCP 配置 |
| **删除** | `ccman mcp remove <name>` | 删除 MCP 服务器 |
| **启用/禁用** | 通过 edit 修改 `enabledApps` | 控制哪些工具启用该 MCP |

**配置存储位置：**
- ccman 内部：`~/.ccman/mcp.json`
- 同步到官方配置：
  - Claude: `~/.claude/settings.json` 的 `mcpServers` 字段
  - Gemini: `~/.gemini/settings.json` 的 `mcpServers` 字段

### 2.3 预设（Preset）管理

**内置预设：**
- **Codex**: 1 个（OpenAI 官方）
- **Claude**: 7 个（Anthropic 官方 + 常见代理服务商）
- **Gemini**: 3 个（Google 官方 + AI Studio + Vertex AI）
- **MCP**: 多个常用 MCP 服务器模板

**功能：**
- 快速创建服务商：从预设模板一键生成
- 自定义预设：用户可添加自己的预设模板
- 预设编辑/删除（仅用户自定义预设可删除，内置预设不可删）

### 2.4 WebDAV 云同步

| 功能 | CLI 命令 | 说明 |
|------|---------|------|
| **配置同步** | `ccman sync config` | 配置 WebDAV 连接信息 |
| **测试连接** | `ccman sync test` | 测试 WebDAV 连接是否正常 |
| **查看状态** | `ccman sync status` | 查看本地和云端的同步状态 |
| **上传覆盖** | `ccman sync upload` | 上传本地配置到云端（覆盖云端）|
| **下载覆盖** | `ccman sync download` | 下载云端配置到本地（覆盖本地）|
| **智能合并** | `ccman sync merge` | 云端和本地智能合并（去重、保留最新）|

**安全机制：**
- API Key AES-256 加密存储
- 上传前自动备份本地配置
- 下载前自动备份本地配置
- 合并失败自动回滚

**同步内容：**
- 所有工具的服务商配置（`~/.ccman/*.json`）
- MCP 服务器配置（`~/.ccman/mcp.json`）
- 工具官方配置文件（可选）

### 2.5 配置导入导出

| 功能 | CLI 命令 | 说明 |
|------|---------|------|
| **导出** | `ccman export [dir]` | 导出所有配置到目录（默认 `~/ccman-backup`）|
| **导入** | `ccman import [dir]` | 从目录导入配置 |

**导出内容：**
- `~/.ccman/` 目录所有文件
- `~/.codex/` 官方配置（可选）
- `~/.claude/` 官方配置（可选）
- `~/.gemini/` 官方配置（可选）

**安全机制：**
- 导入前验证文件格式
- 导入前自动备份现有配置
- 导入失败自动回滚

### 2.6 Claude 历史清理

| 功能 | CLI 命令 | 说明 |
|------|---------|------|
| **分析** | `ccman clean analyze` | 分析 `~/.claude.json` 文件大小 |
| **清理** | `ccman clean` | 清理项目缓存、会话历史等 |

**清理选项：**
- 清理项目历史（按项目路径）
- 清理缓存条目
- 清理会话历史
- 自定义清理范围

---

## 三、技术特性

### 3.1 零破坏性写入
- **原则：** 仅修改托管字段，保留用户自定义配置
- **实现：**
  - 写入前备份原文件（`.bak` 后缀）
  - 深度合并配置（老配置优先）
  - 失败时自动回滚
  - 使用 `fs.rename` 原子操作

### 3.2 安全机制
- **文件权限：** 所有配置文件 `0o600`，目录 `0o700`
- **加密存储：** WebDAV 同步时 API Key 使用 AES-256 加密
- **备份恢复：** 所有写入操作前自动备份

### 3.3 环境隔离
- **生产环境：** `~/.ccman`, `~/.codex`, `~/.claude`, `~/.gemini`
- **开发环境：** `NODE_ENV=development` → `/tmp/ccman-dev`
- **测试环境：** `NODE_ENV=test` → `/tmp/ccman-test-{PID}`

### 3.4 跨平台支持
- macOS / Windows / Linux
- 使用 `path.join()` 确保路径兼容
- 使用 `os.homedir()` 动态获取用户目录

---

## 四、Desktop（Electron）功能

### 4.1 可视化管理
- **服务商管理：** 图形化添加、编辑、删除、切换
- **MCP 管理：** 可视化配置 MCP 服务器
- **WebDAV 同步：** 一键上传、下载、合并

### 4.2 用户体验
- **实时状态：** 显示当前使用的服务商
- **错误提示：** 友好的错误信息和解决方案
- **操作确认：** 重要操作（删除、覆盖）需要确认

---

## 五、功能覆盖矩阵

| 功能 | Codex | Claude | Gemini | MCP |
|------|:-----:|:------:|:------:|:---:|
| 服务商管理 | ✅ | ✅ | ✅ | ✅ |
| 预设模板 | ✅ | ✅ | ✅ | ✅ |
| 克隆服务商 | ✅ | ✅ | ✅ | ✅ |
| MCP 支持 | ❌ | ✅ | ✅ | N/A |
| 云同步 | ✅ | ✅ | ✅ | ✅ |
| 导入导出 | ✅ | ✅ | ✅ | ✅ |
| CLI 命令 | ✅ | ✅ | ✅ | ✅ |
| Desktop UI | ✅ | ✅ | ✅ | ✅ |

---

## 六、用户场景示例

### 场景 1：切换服务商
```bash
# 查看所有服务商
ccman cx list

# 切换到某个服务商
ccman cx use codex-1234567890-abc

# 验证当前服务商
ccman cx current
```

### 场景 2：云同步配置
```bash
# 配置 WebDAV
ccman sync config

# 上传配置到云端
ccman sync upload

# 在另一台机器下载配置
ccman sync download
```

### 场景 3：管理多个 Key
```bash
# 克隆现有服务商
ccman cc clone claude-official mykey2

# 编辑新服务商的 API Key
ccman cc edit mykey2

# 切换使用
ccman cc use mykey2
```

---

## 七、重构必须保留的功能

重构后，**所有上述功能必须保留**，包括：
- ✅ 所有 CLI 命令
- ✅ 所有 Desktop 功能
- ✅ 零破坏性写入
- ✅ 安全机制（加密、备份、回滚）
- ✅ 环境隔离
- ✅ 数据格式兼容（`~/.ccman/*.json` 不变）

---

## 八、已知限制和改进空间

### 8.1 当前限制
1. **Codex 不支持 MCP**（官方限制）
2. **测试环境路径带 PID**（进程重启后路径变化）
3. **模板文件未充分利用**（部分硬编码在代码中）
4. **新增工具需改多个文件**（虽然已有工厂模式，但还不够彻底）

### 8.2 改进方向（重构目标）
- ✅ **完全插件化：** 新增工具只需添加工具描述符
- ✅ **统一模板系统：** 所有工具使用文件模板而非硬编码
- ✅ **固定测试路径：** `/tmp/ccman-test`（无 PID）
- ✅ **ccman 自身抽象：** ccman 也成为工具实例之一

---

**版本：** v1.0.0 (基于 2025-12-07 代码)
**下一步：** 查看 [新架构设计文档](./01-新架构设计.md)
