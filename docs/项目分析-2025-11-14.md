# ccman 项目深度分析（2025-11-14）

> 注: 更细粒度、按源码实时梳理的分析文档已经拆分到 `analysis/` 目录(例如 `analysis/INDEX.md`、`analysis/A-项目概述与定位.md` 等),本文件作为“主视图”保留总体结论与历史背景,具体实现细节与后续改动建议以 `analysis/` 目录为准。

## 1. 结论摘要
- ccman 已形成「Core + CLI + Desktop」三层协同架构，核心代码集中在 `packages/core` 并通过 `@ccman/core` 供上下游复用。
- 功能覆盖 Codex/Claude Code 服务商切换、WebDAV 同步、MCP Server 管理、导入导出与 ~/.claude.json 清理，定位明确。
- 工程实践存在「环境依赖未被自动守卫」「命名规范与文档脱节」「CLI/Desktop 行为未复用测试」等隐患，需要体系化治理。
- WebDAV 加密、MCP 自动同步等设计在文档与实现之间保持一致，是后续扩展（多工具/多端）的良好基础。

## 2. 代码与架构现状
### 2.1 Monorepo 结构
- 根目录使用 pnpm workspace（`pnpm-workspace.yaml`），公共脚本集中在 `scripts/`。
- 三个主包：`packages/core`（业务逻辑）、`packages/cli`（Commander CLI）、`packages/desktop`（Electron+React UI）。
- 依赖 Node ≥ 18 与 pnpm ≥ 7；当前开发机默认 Node 16.20.2，已导致运行时与测试异常。

### 2.2 Core 模块
- `tool-manager.ts` 采用配置驱动 + 工厂模式，抽象 Codex/Claude/MCP 三类 provider：
  - 配置路径来自 `paths.ts`，区分 dev/test/prod 目录，避免污染真实配置。
  - Writers (`writers/codex.ts`, `writers/claude.ts`, `writers/mcp.ts`) 对外部工具做「零破坏性」写入。
  - `presets/` 维护内置服务商模板，但 `codex.ts` 目前仅包含 88Code，远少于 README 中宣称的 7 个预设。
- `sync/` 子目录实现 WebDAV 加密同步（AES-256-GCM，PBKDF2 派生），并提供云端合并策略（`merge-advanced.ts`, `sync-v2.ts`）。
- `claude-clean.ts`、`export.ts` 等模块扩展维护工具功能，为 Desktop/CLI 提供额外仪表板能力。

### 2.3 CLI
- `packages/cli/src/index.ts` 以 Commander 管理 `cx`, `cc`, `mcp`, `sync`, `export`, `import` 子命令。
- 交互式体验通过 `interactive.ts` + inquirer，串联 provider CRUD、预设选择、同步等高频操作。
- CLI 直接依赖 `@ccman/core`，无额外胶水便于共享逻辑，但也意味着 CLI 兼容性受 Core 变更影响较大（缺少 API 层版本保护）。

### 2.4 Desktop
- Electron 主进程 (`packages/desktop/src/main/index.ts`) 直接调用 Core API，提供 Codex/Claude/MCP/Sync/Clean/ImportExport IPC 通道。
- Preload (`src/preload/index.ts`) 将 API 暴露在 `window.electronAPI` 下，Renderer（React，`renderer/App.tsx`）仅通过此桥接访问——满足「UI 层不直接触碰 Electron API」的架构约束。
- Renderer 采用 Dashboard + Mini Sidebar 的布局，组件拆分涵盖 MCP 管理、WebDAV 配置、清理工具等。

## 3. 关键业务能力
### 3.1 服务商管理
- Core 通过 `ToolManager` 维护 `providers` 列表、当前 ID、预设模板。
- Codex Writer 支持多 provider 并写入 `~/.codex/config.toml` 与 `auth.json`；Claude Writer 更新 `~/.claude/settings.json` 中的 `env` 字段。
- CLI/桌面端均提供新增、切换、克隆、编辑、删除等操作，内部复用同一 Core API。

### 3.2 WebDAV 同步
- 配置保存在 `~/.ccman/config.json` 的 `sync` 字段，包含 WebDAV URL、账号密码、远端目录、同步密码等。
- 上传/下载流程：读取本地 `codex.json`/`claude.json` → （加密） → WebDAV；下载时自动备份并与本地合并。
- Desktop 文档（`docs/WebDAV功能分析.md`）与实现保持一致：AES-256-GCM，加盐 PBKDF2，远端数据结构记录 `encryptedApiKey`。

### 3.3 MCP Server 管理
- Core 将 MCP 也视作 provider，持久化在 `~/.ccman/mcp.json`；`writers/mcp.ts` 负责与 `~/.claude.json` 的 `mcpServers` 字段同步。
- Desktop 的 MCP 页面支持启用/禁用 MCP 在 Claude/Codex/Cursor/Windsurf 上的状态，未来可拓展更多 IDE。

### 3.4 导入导出与清理
- `export.ts`、`import.ts` 处理配置批量迁移；Desktop UI 和 CLI 子命令都会调用。
- `claude-clean.ts` 提供 `analyze`, `clean`, `getProjectHistory` 等接口，用于 Desktop 的清理页，支持三档清理策略与备份。

## 4. 工程质量评估
### 4.1 测试现状
- Core 使用 Vitest（`packages/core/vitest.config.ts`），CLI 与 Desktop 暂无测试脚本。
- 在 2025-11-14 的本地环境运行 `pnpm test` 失败：Node 16 缺失 Web Crypto API（`crypto.getRandomValues`），导致 Vite/Vitest 初始化崩溃。
- 当前仓库无自动检测 Node 版本的机制（例如 `.nvmrc`、`engines` 检查钩子、preinstall guard），易导致贡献者重复踩坑。

### 4.2 构建链
- Core：`tsc`；CLI：`tsup`；Desktop：`tsc + vite build` + `electron-builder`。
- 根 `pnpm build` 排除了 Desktop，说明桌面端构建成本较高，需要单独触发。
- 尚未配置 CI（根目录缺少 `.github/workflows` 对应 build/test 流程），GitHub Actions 文档存在但未看到实际 pipeline。

### 4.3 文档与实现对齐
- `docs/架构设计方案.md` 强调类型命名应该使用 `claudecode`，而 Core 代码已统一使用 `'claude'`。文档与代码不一致可能误导新贡献者。
- README 宣称 Codex 具备「7 个常用服务商模板」，但 `packages/core/src/presets/codex.ts` 只定义了 `88Code`，Desktop/CLI 展示与文案不符。
- Docs/需求文件夹说明 Electron UI 与 Core 间需胶水层，但 Preload 仅封装 IPC，没有抽象 service 层（若未来迁移 Tauri，需要再做适配）。

### 4.4 配置与安全
- Writers 在写入前使用 `ensureDir` 并设置 0600 权限，安全意识较强。
- Sync 功能将 WebDAV 密码明文存储在本地 config.json，依赖文件权限保护；若要进一步提升安全性，可引入 macOS Keychain/Windows Credential Manager。
- MCP 配置自动备份 managed server names，避免 Desktop 删除后残留，但 `cursor`/`windsurf` 部分仍是 TODO。

## 5. 风险与问题
1. **运行环境漂移**：Node 18 要求未被执行层 enforcing，导致开发/测试无法运行；CI 也缺失对应检查。
2. **命名/约定偏差**：文档强调 `Claude Code` 命名规范，但代码、配置文件继续沿用 `claude`，需要统一口径或更新文档。
3. **预设数据欠缺**：Codex 预设与 README 描述不一致，影响用户体验与信任度。
4. **MCP 多应用支持未完成**：`writeMCPConfigForApp` 中 Cursor/Windsurf 仍为 TODO，Desktop UI 已暴露可切换入口，实际操作会无效果。
5. **测试覆盖面不足**：只有 Core Writer/Sync 的部分单测；CLI/桌面端缺少回归测试，未来改动风险高。
6. **Web 安全/同步口令**：同步密码可选记忆，若用户选择记住则以明文写入 config.json，需要在 UI 中明确风险提示。

## 6. 深刻反思与改进方向
- **架构一致性**：文档与实现长期偏离说明，架构规范需要定期审查。可以设立「架构守护清单」或 ADR，每次大版本同步更新。否则在多贡献者环境中，文档成为历史遗迹无法指导实践。
- **环境自描述**：当前项目高度依赖本地文件系统（~/.ccman、~/.codex、~/.claude）。若开发/测试环境不隔离，会误伤真实配置。建议在 CLI/桌面启动时显式输出当前 `NODE_ENV` 与路径（CLI 仅在 dev 模式下输出），并允许通过 flag 强制指向 sandbox。
- **功能-数据驱动**：ToolManager 已是数据驱动，但预设、同步策略等仍散落在多个文件与文档中。可考虑将 README 中的预设表直接生成自 `presets/*.ts`，减少描述性失真。
- **质量自动化**：缺乏 CI 让「工程规范」停留在文档。至少需要：Node 18 + pnpm 8 的 install/test pipeline；lint 格式化；Desktop smoke build（可选）。
- **安全边界**：项目定位于管理 API Key，应在 CLI/桌面端提供更清晰的安全提示，并考虑引入系统级秘钥存储。另一个潜在策略是在 Sync/Export 时默认脱敏 API Key，除非用户明确同意。

## 7. 行动建议
1. **立即**：在仓库根目录添加 `.nvmrc`/`.tool-versions` 并在 `preinstall` 钩子校验 Node ≥ 18，防止测试再次因环境报错。
2. **近期**：补齐 Codex 预设（与 README 对齐），或更新 README 说明实际内置列表。
3. **中期**：补完 MCP 对 Cursor/Windsurf 的写入路径实现，确保 Desktop 的启用开关有真实效果。
4. **中期**：建立最小 CI （core lint + core tests + CLI smoke build），并将 `pnpm test` 拆分，使 Node 16 用户也能看到清晰的失败指示。
5. **长期**：规划安全策略（Keychain 集成、同步密码 UX 提示）与文档同步流程，确保当架构或命名原则变更时能快速更新。

---
> 以上分析基于 2025-11-14 仓库状态（分支 `feature/dashboard-navigation`）。如需更细颗粒的模块评估，可在确认 Node 18 环境后补充 CLI/Desktop 的运行验证。
