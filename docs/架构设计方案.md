# ccman æ¶æ„è®¾è®¡æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v2.0
> **æ—¥æœŸ**: 2025-01-07
> **çŠ¶æ€**: æœ€ç»ˆæ–¹æ¡ˆ

## ç›®å½•

- [ä¸€ã€æ ¸å¿ƒè®¾è®¡åŸåˆ™](#ä¸€æ ¸å¿ƒè®¾è®¡åŸåˆ™)
- [äºŒã€æ•´ä½“æ¶æ„](#äºŒæ•´ä½“æ¶æ„)
- [ä¸‰ã€å‘½ä»¤ç»“æ„è®¾è®¡](#ä¸‰å‘½ä»¤ç»“æ„è®¾è®¡)
- [å››ã€æ•°æ®ç»“æ„è®¾è®¡](#å››æ•°æ®ç»“æ„è®¾è®¡)
- [äº”ã€ç¯å¢ƒé…ç½®æ–¹æ¡ˆ](#äº”ç¯å¢ƒé…ç½®æ–¹æ¡ˆ)
- [å…­ã€æ¨¡å—è¯¦ç»†è®¾è®¡](#å…­æ¨¡å—è¯¦ç»†è®¾è®¡)
- [ä¸ƒã€å·¥ä½œæµç¨‹](#ä¸ƒå·¥ä½œæµç¨‹)
- [å…«ã€ä»£ç ç¤ºä¾‹](#å…«ä»£ç ç¤ºä¾‹)
- [ä¹ã€æµ‹è¯•ç­–ç•¥](#ä¹æµ‹è¯•ç­–ç•¥)
- [åã€ä¸æ—§è®¾è®¡çš„å¯¹æ¯”](#åä¸æ—§è®¾è®¡çš„å¯¹æ¯”)

---

## ä¸€ã€æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1.1 æ¶æ„åˆ†å±‚åŸåˆ™

```
User Interface Layer (ç”¨æˆ·ç•Œé¢å±‚)
  - Desktop (Electron å›¾å½¢ç•Œé¢)
  - CLI (å‘½ä»¤è¡Œç•Œé¢)
  â†“ åªè°ƒç”¨ Core API
Core Layer (æ ¸å¿ƒä¸šåŠ¡å±‚)
  â”œâ”€â”€ Business Logic (ä¸šåŠ¡é€»è¾‘)
  â”‚   - tool-manager.ts (å·¥å‚å‡½æ•°)
  â”‚   - config/ (é…ç½®æ–‡ä»¶è¯»å†™)
  â”‚   - presets/ (é¢„è®¾æœåŠ¡å•†)
  â”‚   - paths.ts (ç¯å¢ƒæ„ŸçŸ¥è·¯å¾„)
  â”‚
  â””â”€â”€ Writers (å¤–éƒ¨é›†æˆ - Core çš„å†…éƒ¨æ¨¡å—)
      - writers/codex.ts
      - writers/claudecode.ts
```

**èŒè´£æ¸…æ™°**ï¼š
- **User Interface Layer**:
  - Desktop: Electron å›¾å½¢ç•Œé¢ï¼Œé€šè¿‡ IPC è°ƒç”¨ Core
  - CLI: å‘½ä»¤è¡Œç•Œé¢ï¼Œç›´æ¥è°ƒç”¨ Core
- **Core Layer**:
  - ç®¡ç† ccman è‡ªå·±çš„æ•°æ®ï¼ˆ`~/.ccman/`ï¼‰
  - æä¾›ç»Ÿä¸€çš„ APIï¼ˆ`codex.*`, `claudeCode.*`ï¼‰
  - **åŒ…å« Writers æ¨¡å—**ï¼šè´Ÿè´£å†™å…¥å¤–éƒ¨å·¥å…·é…ç½®ï¼ˆ`~/.codex/`, `~/.claude/`ï¼‰

**é‡è¦è¯´æ˜**ï¼šWriters ä¸æ˜¯ç‹¬ç«‹çš„ä¸€å±‚ï¼Œè€Œæ˜¯ **Core çš„å†…éƒ¨æ¨¡å—**ï¼ˆä½äº `packages/core/src/writers/`ï¼‰

### 1.2 æ•°æ®åˆ†ç¦»åŸåˆ™

- Codex å’Œ Claude Code çš„æ•°æ®**å®Œå…¨åˆ†ç¦»**
- ä¸¤ä¸ªç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼š`codex.json`, `claudecode.json`
- ä¸¤å¥—ç‹¬ç«‹çš„é¢„è®¾æœåŠ¡å•†ï¼š`CODEX_PRESETS`, `CLAUDECODE_PRESETS`
- ä¸¤å¥—ç‹¬ç«‹çš„ APIï¼š`codex.*`, `claudeCode.*`

### 1.3 ç¯å¢ƒéš”ç¦»åŸåˆ™

- å¼€å‘ç¯å¢ƒ (`development`)ï¼šä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•ç›®å½•
- æµ‹è¯•ç¯å¢ƒ (`test`)ï¼šä½¿ç”¨ä¸´æ—¶ç›®å½•ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
- ç”Ÿäº§ç¯å¢ƒ (`production`)ï¼šä½¿ç”¨æ­£å¼ç›®å½•ï¼ˆ`~/.ccman/`, `~/.codex/`, `~/.claude/`ï¼‰

**æ ¸å¿ƒè¦æ±‚**ï¼šå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ**ç»ä¸èƒ½å½±å“**æ­£å¼ç¯å¢ƒçš„é…ç½®æ–‡ä»¶ã€‚

### 1.4 å‘½åè§„èŒƒåŸåˆ™

**é‡è¦**ï¼šClaude Code â‰  Claude
- Claude Code æ˜¯å·¥å…·åï¼ˆå’Œ Codex å¹³çº§ï¼‰
- Claude æ˜¯ AI æ¨¡å‹å

**å‘½åè§„èŒƒ**ï¼š

| ä½ç½® | æ­£ç¡®å‘½å | é”™è¯¯å‘½å | è¯´æ˜ |
|------|----------|----------|------|
| CLI å‘½ä»¤ | `ccman cx`, `ccman cc` | âŒ `ccman claude` | å‘½ä»¤ç”¨ç¼©å†™ |
| ç±»å‹å®šä¹‰ | `'codex' \| 'claudecode'` | âŒ `'claude'` | ç±»å‹ç”¨å…¨ç§°å°å†™ |
| å˜é‡å | `codex`, `claudeCode` | âŒ `claude` | å˜é‡ç”¨é©¼å³° |
| é…ç½®æ–‡ä»¶ | `codex.json`, `claudecode.json` | âŒ `claude.json` | æ–‡ä»¶ç”¨å…¨ç§°å°å†™ |
| å‡½æ•°å | `writeClaudeCodeConfig()` | âŒ `writeClaudeConfig()` | å‡½æ•°ç”¨å…¨ç§°é©¼å³° |
| å¸¸é‡å | `CLAUDECODE_PRESETS` | âŒ `CLAUDE_PRESETS` | å¸¸é‡ç”¨å…¨ç§°å¤§å†™ |

### 1.5 ç®€æ´æ€§åŸåˆ™

> "Bad programmers worry about the code. Good programmers worry about data structures." - Linus Torvalds

- ä¼˜å…ˆä½¿ç”¨**å‡½æ•°å¼**ï¼Œè€Œä¸æ˜¯é¢å‘å¯¹è±¡ï¼ˆæ¥å£ + ç±»ï¼‰
- åªæœ‰ 2 ä¸ªå·¥å…·ï¼Œä¸éœ€è¦è¿‡åº¦æŠ½è±¡
- ç”¨**å·¥å‚å‡½æ•°**ç”Ÿæˆä¸¤å¥— APIï¼Œè€Œä¸æ˜¯é€‚é…å™¨æ¨¡å¼
- ä»£ç é‡ç›®æ ‡ï¼šCore å±‚ < 200 è¡Œ

---

## äºŒã€æ•´ä½“æ¶æ„

### 2.1 å®Œæ•´æ¶æ„å›¾ï¼ˆåŒ…å« Desktopï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              User Interface Layer (ç”¨æˆ·ç•Œé¢å±‚)                  â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Desktop (Electron)    â”‚      CLI (Node.js)       â”‚       â”‚
â”‚  â”‚  (packages/desktop/)    â”‚    (packages/cli/)       â”‚       â”‚
â”‚  â”‚                         â”‚                          â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  commands/               â”‚       â”‚
â”‚  â”‚  â”‚ Renderer (React) â”‚   â”‚  â”œâ”€â”€ codex.ts            â”‚       â”‚
â”‚  â”‚  â”‚ - CodexPanel     â”‚   â”‚  â”œâ”€â”€ claudecode.ts       â”‚       â”‚
â”‚  â”‚  â”‚ - ClaudeCodePanelâ”‚   â”‚  â””â”€â”€ status.ts           â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                          â”‚       â”‚
â”‚  â”‚          â†“ IPC          â”‚  ç‰¹ç‚¹ï¼š                  â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  - äº¤äº’å¼è¾“å…¥(inquirer)  â”‚       â”‚
â”‚  â”‚  â”‚ Preload Script   â”‚   â”‚  - ç›´æ¥è°ƒç”¨ Core        â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                          â”‚       â”‚
â”‚  â”‚          â†“ IPC          â”‚                          â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                          â”‚       â”‚
â”‚  â”‚  â”‚ Main (Node.js)   â”‚   â”‚                          â”‚       â”‚
â”‚  â”‚  â”‚ - IPC Handlers   â”‚   â”‚                          â”‚       â”‚
â”‚  â”‚  â”‚ - ç›´æ¥è°ƒç”¨ Core  â”‚   â”‚                          â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚              â†“                         â†“                       â”‚
â”‚         import Core               import Core                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Core Layer (æ ¸å¿ƒä¸šåŠ¡å±‚)                        â”‚
â”‚                  (packages/core/src/)                          â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Business Logic (ä¸šåŠ¡é€»è¾‘)                            â”‚     â”‚
â”‚  â”‚                                                      â”‚     â”‚
â”‚  â”‚  tool-manager.tsï¼ˆå·¥å‚å‡½æ•° - æ ¸å¿ƒé€»è¾‘ï¼‰              â”‚     â”‚
â”‚  â”‚    createToolManager(tool: ToolType) â†’ ToolManager  â”‚     â”‚
â”‚  â”‚                                                      â”‚     â”‚
â”‚  â”‚  å¯¼å‡º APIï¼š                                          â”‚     â”‚
â”‚  â”‚    export const codex = createToolManager('codex')  â”‚     â”‚
â”‚  â”‚    export const claudeCode = ...('claudecode')      â”‚     â”‚
â”‚  â”‚                                                      â”‚     â”‚
â”‚  â”‚  config/ï¼ˆé…ç½®æ–‡ä»¶è¯»å†™ï¼‰                             â”‚     â”‚
â”‚  â”‚    â”œâ”€â”€ codex.ts        ~/.ccman/codex.json         â”‚     â”‚
â”‚  â”‚    â””â”€â”€ claudecode.ts   ~/.ccman/claudecode.json    â”‚     â”‚
â”‚  â”‚                                                      â”‚     â”‚
â”‚  â”‚  presets/ï¼ˆé¢„è®¾æœåŠ¡å•†ï¼‰                              â”‚     â”‚
â”‚  â”‚    â”œâ”€â”€ codex.ts        CODEX_PRESETS                â”‚     â”‚
â”‚  â”‚    â””â”€â”€ claudecode.ts   CLAUDECODE_PRESETS           â”‚     â”‚
â”‚  â”‚                                                      â”‚     â”‚
â”‚  â”‚  paths.tsï¼ˆç¯å¢ƒæ„ŸçŸ¥çš„è·¯å¾„ç®¡ç†ï¼‰                      â”‚     â”‚
â”‚  â”‚    - getCcmanDir()  æ ¹æ® NODE_ENV è¿”å›å¯¹åº”ç›®å½•     â”‚     â”‚
â”‚  â”‚    - getCodexDir()                                  â”‚     â”‚
â”‚  â”‚    - getClaudeDir()                                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Writers (å¤–éƒ¨é›†æˆ - Core çš„å†…éƒ¨æ¨¡å—)                 â”‚     â”‚
â”‚  â”‚                                                      â”‚     â”‚
â”‚  â”‚  writers/codex.ts                                   â”‚     â”‚
â”‚  â”‚    export function writeCodexConfig(provider)       â”‚     â”‚
â”‚  â”‚      â†’ è¯»å– ~/.codex/config.toml                    â”‚     â”‚
â”‚  â”‚      â†’ æ›´æ–° model_provider å’Œ model_providers       â”‚     â”‚
â”‚  â”‚      â†’ å†™å…¥ ~/.codex/config.toml                    â”‚     â”‚
â”‚  â”‚      â†’ å†™å…¥ ~/.codex/auth.json                      â”‚     â”‚
â”‚  â”‚                                                      â”‚     â”‚
â”‚  â”‚  writers/claudecode.ts                              â”‚     â”‚
â”‚  â”‚    export function writeClaudeCodeConfig(provider)  â”‚     â”‚
â”‚  â”‚      â†’ è¯»å– ~/.claude/settings.json                 â”‚     â”‚
â”‚  â”‚      â†’ æ›´æ–° ANTHROPIC_AUTH_TOKEN/BASE_URL           â”‚     â”‚
â”‚  â”‚      â†’ å†™å…¥ ~/.claude/settings.json                 â”‚     â”‚
â”‚  â”‚                                                      â”‚     â”‚
â”‚  â”‚  ç‰¹ç‚¹ï¼š                                              â”‚     â”‚
â”‚  â”‚    âœ… çº¯å‡½æ•°ï¼Œä¸æ˜¯ç±»                                â”‚     â”‚
â”‚  â”‚    âœ… å•ä¸€èŒè´£ï¼šåªè´Ÿè´£å†™å…¥å¤–éƒ¨å·¥å…·é…ç½®               â”‚     â”‚
â”‚  â”‚    âœ… é›¶ç ´åæ€§ï¼šè¯»å–-åˆå¹¶-å†™å…¥æ¨¡å¼                   â”‚     â”‚
â”‚  â”‚    âœ… ç¯å¢ƒæ„ŸçŸ¥ï¼ˆæ ¹æ® NODE_ENV å†³å®šå†™å…¥è·¯å¾„ï¼‰        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                â”‚
â”‚  è¯´æ˜ï¼šWriters æ˜¯ Core çš„å†…éƒ¨æ¨¡å—ï¼Œä½äº                       â”‚
â”‚        packages/core/src/writers/                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 é¡¹ç›®ç›®å½•ç»“æ„

```
packages/
â”œâ”€â”€ core/                    # Core Layerï¼ˆæ ¸å¿ƒä¸šåŠ¡å±‚ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ tool-manager.ts  # å·¥å‚å‡½æ•°ï¼Œå¯¼å‡º codex å’Œ claudeCode
â”‚   â”‚   â”œâ”€â”€ types.ts         # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ paths.ts         # ç¯å¢ƒæ„ŸçŸ¥è·¯å¾„ç®¡ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ config/          # é…ç½®æ–‡ä»¶è¯»å†™ï¼ˆccman è‡ªå·±çš„æ•°æ®ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ codex.ts
â”‚   â”‚   â”‚   â””â”€â”€ claudecode.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ presets/         # é¢„è®¾æœåŠ¡å•†
â”‚   â”‚   â”‚   â”œâ”€â”€ codex.ts
â”‚   â”‚   â”‚   â””â”€â”€ claudecode.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ writers/         # â­ Writersï¼ˆCore çš„å†…éƒ¨æ¨¡å—ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ codex.ts     # å†™å…¥ ~/.codex/config.toml
â”‚   â”‚   â”‚   â””â”€â”€ claudecode.ts # å†™å…¥ ~/.claude/settings.json
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ file.ts
â”‚   â”‚       â””â”€â”€ validator.ts
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ cli/                     # CLI Layerï¼ˆå‘½ä»¤è¡Œç•Œé¢ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”‚   â”œâ”€â”€ codex.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ claudecode.ts
â”‚   â”‚   â”‚   â””â”€â”€ status.ts
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â””â”€â”€ package.json
â”‚
â””â”€â”€ desktop/                 # Desktop Layerï¼ˆå›¾å½¢ç•Œé¢ï¼‰
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ main/            # Main Process
    â”‚   â”‚   â”œâ”€â”€ index.ts
    â”‚   â”‚   â”œâ”€â”€ ipc-handlers.ts  # ç›´æ¥è°ƒç”¨ Core
    â”‚   â”‚   â””â”€â”€ window.ts
    â”‚   â”œâ”€â”€ preload/         # Preload Script
    â”‚   â”‚   â””â”€â”€ index.ts
    â”‚   â””â”€â”€ renderer/        # Renderer Process
    â”‚       â”œâ”€â”€ App.tsx
    â”‚       â””â”€â”€ components/
    â””â”€â”€ package.json
```

**é‡ç‚¹è¯´æ˜**ï¼š
- **Writers åœ¨ `packages/core/src/writers/` ç›®å½•ä¸‹**
- Writers æ˜¯ Core çš„å†…éƒ¨æ¨¡å—ï¼Œä¸æ˜¯ç‹¬ç«‹çš„ package
- CLI å’Œ Desktop éƒ½è°ƒç”¨ Coreï¼ŒCore å†…éƒ¨è°ƒç”¨ Writers

### 2.3 æ•°æ®æµå‘å›¾

#### CLI æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥
  â†“
ccman cx add
  â†“
CLI Layer (commands/codex.ts)
  â†“ è°ƒç”¨
codex.addProvider(input)
  â†“
Core Layer (tool-manager.ts)
  â”œâ”€â†’ 1. ä¿å­˜åˆ° ~/.ccman/codex.json
  â””â”€â†’ 2. è°ƒç”¨ writeCodexConfig(provider)
        â†“
Writers Layer (writers/codex.ts)
  â””â”€â†’ å†™å…¥ ~/.codex/config.toml + auth.json
```

#### Desktop æ•°æ®æµ

```
ç”¨æˆ·ç‚¹å‡»"æ·»åŠ  Codex æœåŠ¡å•†"
  â†“
Renderer (CodexPanel.tsx)
  â”œâ”€â†’ 1. æ˜¾ç¤º ProviderForm
  â”œâ”€â†’ 2. è°ƒç”¨ window.electronAPI.codex.getPresets()
  â”‚     â†“ IPC
  â”‚   Preload Script
  â”‚     â†“ IPC
  â”‚   Main Process â†’ codex.getPresets()
  â”‚     â†“ è¿”å›
  â”‚   æ˜¾ç¤ºé¢„è®¾åˆ—è¡¨
  â”‚
  â””â”€â†’ 3. ç”¨æˆ·æäº¤è¡¨å•
      â†“ è°ƒç”¨ window.electronAPI.codex.addProvider(input)
        â†“ IPC
      Preload Script
        â†“ IPC
      Main Process
        â†“ è°ƒç”¨
      codex.addProvider(input)
        â†“
      Core Layer (tool-manager.ts)
        â”œâ”€â†’ 1. ä¿å­˜åˆ° ~/.ccman/codex.json
        â””â”€â†’ 2. è°ƒç”¨ writeCodexConfig(provider)
              â†“
        Writers Layer (writers/codex.ts)
          â””â”€â†’ å†™å…¥ ~/.codex/config.toml + auth.json
              â†“ è¿”å›
        Renderer: æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œåˆ·æ–°åˆ—è¡¨
```

### 2.4 Desktop å±‚è¯¦ç»†è®¾è®¡ï¼ˆå…³æ³¨ç‚¹åˆ†ç¦»ï¼‰

#### æ¶æ„åŸåˆ™

Desktop åŸºäº Electronï¼Œé‡‡ç”¨**ä¸¥æ ¼çš„ä¸‰å±‚å…³æ³¨ç‚¹åˆ†ç¦»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Renderer Process (React)                                â”‚
â”‚ å…³æ³¨ç‚¹ï¼šUI å±•ç¤º + ç”¨æˆ·äº¤äº’                              â”‚
â”‚ èŒè´£ï¼š                                                  â”‚
â”‚   âœ… UI ç»„ä»¶æ¸²æŸ“                                        â”‚
â”‚   âœ… ç”¨æˆ·äº¤äº’å¤„ç†ï¼ˆè¡¨å•ã€æŒ‰é’®ï¼‰                         â”‚
â”‚   âœ… è°ƒç”¨ window.electronAPI.*                          â”‚
â”‚   âŒ ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘                                     â”‚
â”‚   âŒ ä¸èƒ½ç›´æ¥è®¿é—® Node.js API                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Preload Script                                          â”‚
â”‚ å…³æ³¨ç‚¹ï¼šAPI æš´éœ²ï¼ˆå®‰å…¨æ¡¥æ¢ï¼‰                            â”‚
â”‚ èŒè´£ï¼š                                                  â”‚
â”‚   âœ… contextBridge.exposeInMainWorld()                  â”‚
â”‚   âœ… å®šä¹‰ electronAPI æ¥å£                              â”‚
â”‚   âŒ ä¸åŒ…å«ä»»ä½•é€»è¾‘                                     â”‚
â”‚   âŒ åªæ˜¯ IPC çš„è–„å°è£…                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Main Process (Node.js)                                  â”‚
â”‚ å…³æ³¨ç‚¹ï¼šIPC å¤„ç† + è°ƒç”¨ Core                            â”‚
â”‚ èŒè´£ï¼š                                                  â”‚
â”‚   âœ… ipcMain.handle() æ³¨å†Œ IPC å¤„ç†å™¨                   â”‚
â”‚   âœ… ç›´æ¥è°ƒç”¨ Core API                                  â”‚
â”‚   âœ… çª—å£ç®¡ç†ã€èœå•ç®¡ç†                                 â”‚
â”‚   âŒ ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ˆå’Œ CLI ä¸€æ ·ï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ import
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Core Layer                                              â”‚
â”‚ å…³æ³¨ç‚¹ï¼šä¸šåŠ¡é€»è¾‘ + æ•°æ®ç®¡ç†                             â”‚
â”‚ èŒè´£ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½åœ¨è¿™é‡Œ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Desktop ç›®å½•ç»“æ„

```
packages/desktop/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/                    # Main Processï¼ˆNode.js ç¯å¢ƒï¼‰
â”‚   â”‚   â”œâ”€â”€ index.ts             # åº”ç”¨å…¥å£
â”‚   â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚   â”‚   â”‚       - app.whenReady() ç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â”‚       - åˆ›å»ºçª—å£
â”‚   â”‚   â”‚       - æ³¨å†Œ IPC handlers
â”‚   â”‚   â”‚       - åº”ç”¨é€€å‡ºå¤„ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ window.ts            # çª—å£ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚   â”‚   â”‚       - createMainWindow()
â”‚   â”‚   â”‚       - BrowserWindow é…ç½®
â”‚   â”‚   â”‚       - å®‰å…¨é…ç½®ï¼ˆcontextIsolation, nodeIntegrationï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ipc-handlers.ts      # â­ IPC å¤„ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚   â”‚   â”‚       - æ³¨å†Œæ‰€æœ‰ ipcMain.handle()
â”‚   â”‚   â”‚       - ç›´æ¥è°ƒç”¨ Core APIï¼ˆimport { codex, claudeCode }ï¼‰
â”‚   â”‚   â”‚       - é”™è¯¯å¤„ç†
â”‚   â”‚   â”‚       - å…³æ³¨ç‚¹ï¼šIPC è½¬å‘ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ menu.ts              # èœå•ç®¡ç†ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ èŒè´£ï¼šåº”ç”¨èœå•ã€å³é”®èœå•
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tray.ts              # ç³»ç»Ÿæ‰˜ç›˜ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ èŒè´£ï¼šæ‰˜ç›˜å›¾æ ‡ã€æ‰˜ç›˜èœå•
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ updater.ts           # è‡ªåŠ¨æ›´æ–°ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚       â””â”€â”€ èŒè´£ï¼šæ£€æŸ¥æ›´æ–°ã€ä¸‹è½½ã€å®‰è£…
â”‚   â”‚
â”‚   â”œâ”€â”€ preload/                 # Preload Scriptï¼ˆå®‰å…¨æ¡¥æ¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ index.ts             # Preload å…¥å£
â”‚   â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚   â”‚   â”‚       - contextBridge.exposeInMainWorld()
â”‚   â”‚   â”‚       - æš´éœ² window.electronAPI
â”‚   â”‚   â”‚       - å…³æ³¨ç‚¹ï¼šAPI æš´éœ²ï¼Œä¸åŒ…å«é€»è¾‘
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ types.ts             # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚       â””â”€â”€ èŒè´£ï¼šå®šä¹‰ window.electronAPI çš„ç±»å‹
â”‚   â”‚
â”‚   â””â”€â”€ renderer/                # Renderer Processï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰
â”‚       â”œâ”€â”€ index.html           # HTML å…¥å£
â”‚       â”œâ”€â”€ index.tsx            # React å…¥å£
â”‚       â”‚
â”‚       â”œâ”€â”€ App.tsx              # â­ åº”ç”¨ä¸»æ¡†æ¶
â”‚       â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚       â”‚       - æ ‡ç­¾é¡µåˆ‡æ¢ï¼ˆCodex / Claude Codeï¼‰
â”‚       â”‚       - å…¨å±€å¸ƒå±€
â”‚       â”‚       - è·¯ç”±ç®¡ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
â”‚       â”‚
â”‚       â”œâ”€â”€ components/          # UI ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ CodexPanel.tsx
â”‚       â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚       â”‚   â”‚       - æ˜¾ç¤º Codex æœåŠ¡å•†åˆ—è¡¨
â”‚       â”‚   â”‚       - æ˜¾ç¤ºå½“å‰æ¿€æ´»çš„æœåŠ¡å•†
â”‚       â”‚   â”‚       - å¤„ç†ç”¨æˆ·äº¤äº’ï¼ˆæ·»åŠ ã€åˆ‡æ¢ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
â”‚       â”‚   â”‚       - è°ƒç”¨ window.electronAPI.codex.*
â”‚       â”‚   â”‚       - å…³æ³¨ç‚¹ï¼šUI å±•ç¤ºï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
â”‚       â”‚   â”‚
â”‚       â”‚   â”œâ”€â”€ ClaudeCodePanel.tsx
â”‚       â”‚   â”‚   â””â”€â”€ èŒè´£ï¼šåŒ CodexPanelï¼Œä½†æ“ä½œ claudeCode
â”‚       â”‚   â”‚
â”‚       â”‚   â”œâ”€â”€ ProviderList.tsx
â”‚       â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚       â”‚   â”‚       - é€šç”¨çš„æœåŠ¡å•†åˆ—è¡¨ç»„ä»¶
â”‚       â”‚   â”‚       - Props: providers, currentProvider
â”‚       â”‚   â”‚       - å›è°ƒ: onSwitch, onEdit, onRemove
â”‚       â”‚   â”‚       - å¯å¤ç”¨ï¼ˆCodex å’Œ Claude Code éƒ½ç”¨ï¼‰
â”‚       â”‚   â”‚
â”‚       â”‚   â”œâ”€â”€ ProviderForm.tsx
â”‚       â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚       â”‚   â”‚       - æ·»åŠ /ç¼–è¾‘æœåŠ¡å•†çš„è¡¨å•
â”‚       â”‚   â”‚       - æ”¯æŒé¢„è®¾é€‰æ‹© or è‡ªå®šä¹‰é…ç½®
â”‚       â”‚   â”‚       - è¡¨å•éªŒè¯ï¼ˆURL æ ¼å¼ã€å¿…å¡«é¡¹ï¼‰
â”‚       â”‚   â”‚       - æäº¤æ—¶è§¦å‘å›è°ƒ
â”‚       â”‚   â”‚
â”‚       â”‚   â”œâ”€â”€ StatusBar.tsx
â”‚       â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚       â”‚   â”‚       - åº•éƒ¨çŠ¶æ€æ 
â”‚       â”‚   â”‚       - æ˜¾ç¤ºä¸¤ä¸ªå·¥å…·çš„å½“å‰çŠ¶æ€
â”‚       â”‚   â”‚       - æ˜¾ç¤ºé…ç½®æ–‡ä»¶è·¯å¾„
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€ Header.tsx
â”‚       â”‚       â””â”€â”€ èŒè´£ï¼šé¡¶éƒ¨æ ‡é¢˜æ ã€Logo
â”‚       â”‚
â”‚       â”œâ”€â”€ hooks/               # React Hooks
â”‚       â”‚   â”œâ”€â”€ useCodexProviders.ts
â”‚       â”‚   â”‚   â””â”€â”€ èŒè´£ï¼š
â”‚       â”‚   â”‚       - å°è£… Codex æ•°æ®è·å–å’Œæ“ä½œé€»è¾‘
â”‚       â”‚   â”‚       - è°ƒç”¨ window.electronAPI.codex.*
â”‚       â”‚   â”‚       - ç®¡ç† loading/error çŠ¶æ€
â”‚       â”‚   â”‚       - å…³æ³¨ç‚¹ï¼šæ•°æ®é€»è¾‘å°è£…ï¼Œä¸åŒ…å« UI
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€ useClaudeCodeProviders.ts
â”‚       â”‚       â””â”€â”€ èŒè´£ï¼šåŒ useCodexProviders
â”‚       â”‚
â”‚       â”œâ”€â”€ styles/              # æ ·å¼æ–‡ä»¶
â”‚       â”‚   â”œâ”€â”€ global.css
â”‚       â”‚   â””â”€â”€ components.css
â”‚       â”‚
â”‚       â””â”€â”€ types/               # TypeScript ç±»å‹
â”‚           â””â”€â”€ electron.d.ts    # æ‰©å±• window.electronAPI ç±»å‹
â”‚
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.ts               # Vite é…ç½®ï¼ˆRenderer æ‰“åŒ…ï¼‰
â””â”€â”€ electron-builder.yml         # Electron æ‰“åŒ…é…ç½®
```

#### å…³æ³¨ç‚¹åˆ†ç¦»ç¤ºä¾‹

**âœ… æ­£ç¡®ç¤ºä¾‹ - Renderer åªç®¡ UI**

```typescript
// renderer/components/CodexPanel.tsx
import { useCodexProviders } from '../hooks/useCodexProviders'

export function CodexPanel() {
  // âœ… ä½¿ç”¨ Hook è·å–æ•°æ®å’Œæ“ä½œæ–¹æ³•
  const { providers, current, addProvider, switchProvider, loading } = useCodexProviders()

  // âœ… UI äº¤äº’å¤„ç†
  const handleAdd = async (input) => {
    await addProvider(input)  // âœ… è°ƒç”¨ Hook æ–¹æ³•
    alert('æ·»åŠ æˆåŠŸ')          // âœ… UI åé¦ˆ
  }

  // âœ… åªç®¡ UI æ¸²æŸ“
  return (
    <div>
      <h2>Codex æœåŠ¡å•†</h2>
      {current && <div>å½“å‰ï¼š{current.name}</div>}
      <ProviderList
        providers={providers}
        currentProvider={current}
        onSwitch={switchProvider}
      />
      <button onClick={() => setShowForm(true)}>æ·»åŠ </button>
    </div>
  )
}
```

**âœ… æ­£ç¡®ç¤ºä¾‹ - Hook å°è£…æ•°æ®é€»è¾‘**

```typescript
// renderer/hooks/useCodexProviders.ts
export function useCodexProviders() {
  const [providers, setProviders] = useState([])
  const [current, setCurrent] = useState(null)
  const [loading, setLoading] = useState(false)

  // âœ… å°è£…æ•°æ®è·å–
  const loadProviders = async () => {
    setLoading(true)
    const data = await window.electronAPI.codex.listProviders()
    setProviders(data)
    setLoading(false)
  }

  const loadCurrent = async () => {
    const data = await window.electronAPI.codex.getCurrent()
    setCurrent(data)
  }

  // âœ… å°è£…æ•°æ®æ“ä½œ
  const addProvider = async (input) => {
    const provider = await window.electronAPI.codex.addProvider(input)
    await loadProviders()  // åˆ·æ–°åˆ—è¡¨
    return provider
  }

  const switchProvider = async (id) => {
    await window.electronAPI.codex.switchProvider(id)
    await loadCurrent()  // åˆ·æ–°å½“å‰
  }

  useEffect(() => {
    loadProviders()
    loadCurrent()
  }, [])

  return { providers, current, addProvider, switchProvider, loading }
}
```

**âœ… æ­£ç¡®ç¤ºä¾‹ - Main Process åªè½¬å‘ IPC**

```typescript
// main/ipc-handlers.ts
import { ipcMain } from 'electron'
import { codex, claudeCode } from '@ccman/core'

export function registerIpcHandlers() {
  // âœ… åªè½¬å‘ IPCï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
  ipcMain.handle('codex-add-provider', async (event, input) => {
    try {
      return codex.addProvider(input)  // âœ… ç›´æ¥è°ƒç”¨ Core
    } catch (error) {
      console.error('[Main] codex-add-provider error:', error)
      throw error  // âœ… é‡æ–°æŠ›å‡ºï¼Œè®© Renderer å¤„ç†
    }
  })

  ipcMain.handle('codex-list-providers', async () => {
    return codex.listProviders()  // âœ… ç›´æ¥è°ƒç”¨ Core
  })

  ipcMain.handle('codex-switch-provider', async (event, id) => {
    codex.switchProvider(id)  // âœ… ç›´æ¥è°ƒç”¨ Core
  })

  // ... å…¶ä»– IPC handlers
}
```

**âŒ é”™è¯¯ç¤ºä¾‹ - Renderer åŒ…å«ä¸šåŠ¡é€»è¾‘**

```typescript
// âŒ ä¸è¦è¿™æ ·åš
export function CodexPanel() {
  const handleAdd = (input) => {
    // âŒ åœ¨ Renderer ä¸­ç”Ÿæˆ ID
    const id = `codex-${Date.now()}-${Math.random()}`

    // âŒ åœ¨ Renderer ä¸­åˆ›å»º Provider
    const provider = {
      id,
      name: input.name,
      baseUrl: input.baseUrl,
      apiKey: input.apiKey,
      createdAt: Date.now(),
    }

    // âŒ åœ¨ Renderer ä¸­åšéªŒè¯
    if (!provider.baseUrl.startsWith('http')) {
      alert('Invalid URL')
      return
    }

    window.electronAPI.codex.saveProvider(provider)
  }
}
```

#### Desktop å’Œ CLI çš„å¯¹æ¯”

| å±‚çº§ | CLI | Desktop | èŒè´£ |
|------|-----|---------|------|
| **ç”¨æˆ·äº¤äº’** | inquirer | React UI | è·å–ç”¨æˆ·è¾“å…¥ |
| **ä¸­é—´å±‚** | æ—  | Preload Script | CLI ç›´æ¥è°ƒç”¨ï¼ŒDesktop éœ€è¦ IPC |
| **ä¸šåŠ¡è°ƒç”¨** | commands/*.ts | Main Process | è°ƒç”¨ Core API |
| **ä¸šåŠ¡é€»è¾‘** | Core | Core | å®Œå…¨ç›¸åŒï¼ |

**å…³é”®ç‚¹**ï¼š
- CLI å’Œ Desktop Main Process çš„ä»£ç **å‡ ä¹ä¸€æ ·**
- åŒºåˆ«åªåœ¨äºï¼š
  - CLI: ç›´æ¥è°ƒç”¨ Core
  - Main: é€šè¿‡ IPC æ¥æ”¶è¯·æ±‚ï¼Œç„¶åè°ƒç”¨ Core
- ä¸šåŠ¡é€»è¾‘**100% åœ¨ Core ä¸­**ï¼Œä¸¤è€…éƒ½ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

---

## ä¸‰ã€å‘½ä»¤ç»“æ„è®¾è®¡

### 3.1 å®Œæ•´å‘½ä»¤åˆ—è¡¨

```bash
# ========== Codex æ“ä½œ ==========
ccman cx add               # æ·»åŠ  Codex æœåŠ¡å•†
ccman cx list              # åˆ—å‡º Codex æœåŠ¡å•†
ccman cx use <name|id>     # åˆ‡æ¢ Codex æœåŠ¡å•†
ccman cx current           # æŸ¥çœ‹ Codex å½“å‰æœåŠ¡å•†
ccman cx edit <name|id>    # ç¼–è¾‘ Codex æœåŠ¡å•†
ccman cx remove <name|id>  # åˆ é™¤ Codex æœåŠ¡å•†
ccman cx init              # åˆå§‹åŒ– Codexï¼ˆé€‰æ‹©é¢„è®¾ï¼‰

# ========== Claude Code æ“ä½œ ==========
ccman cc add               # æ·»åŠ  Claude Code æœåŠ¡å•†
ccman cc list              # åˆ—å‡º Claude Code æœåŠ¡å•†
ccman cc use <name|id>     # åˆ‡æ¢ Claude Code æœåŠ¡å•†
ccman cc current           # æŸ¥çœ‹ Claude Code å½“å‰æœåŠ¡å•†
ccman cc edit <name|id>    # ç¼–è¾‘ Claude Code æœåŠ¡å•†
ccman cc remove <name|id>  # åˆ é™¤ Claude Code æœåŠ¡å•†
ccman cc init              # åˆå§‹åŒ– Claude Codeï¼ˆé€‰æ‹©é¢„è®¾ï¼‰

# ========== å…¨å±€å‘½ä»¤ ==========
ccman status               # æŸ¥çœ‹ä¸¤ä¸ªå·¥å…·çš„å½“å‰çŠ¶æ€
ccman version              # ç‰ˆæœ¬ä¿¡æ¯
ccman help                 # å¸®åŠ©ä¿¡æ¯
```

### 3.2 å‘½ä»¤äº¤äº’ç¤ºä¾‹

```bash
$ ccman cc add

ğŸ“ æ·»åŠ  Claude Code æœåŠ¡å•†

? é€‰æ‹©é…ç½®æ¥æºï¼š
  â¯ ğŸ“¦ ä½¿ç”¨é¢„ç½®æœåŠ¡å•†
    âœï¸  è‡ªå®šä¹‰é…ç½®

? é€‰æ‹©é¢„ç½®æœåŠ¡å•†ï¼š
  â¯ Anthropic Official - Anthropic å®˜æ–¹ API
    AnyRouter - AnyRouter API æœåŠ¡
    PackyCode - PackyCode API æœåŠ¡

? è¾“å…¥ API å¯†é’¥ï¼š ********

âœ… æ·»åŠ æˆåŠŸ

  Anthropic Official [Claude Code]
  ID: claudecode-1234567890-abc123
  URL: https://api.anthropic.com

? æ˜¯å¦ç«‹å³åˆ‡æ¢åˆ°æ­¤æœåŠ¡å•†ï¼Ÿ Yes

âœ… å·²åˆ‡æ¢åˆ°æ–°æœåŠ¡å•†
é…ç½®å·²æ›´æ–°ï¼š~/.claude/settings.json
```

```bash
$ ccman status

ğŸ“Š å½“å‰çŠ¶æ€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Codex                                       â”‚
â”‚   â— OpenAI                                  â”‚
â”‚   URL: https://api.openai.com               â”‚
â”‚   é…ç½®: ~/.codex/config.toml                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Code                                 â”‚
â”‚   â— Anthropic Official                      â”‚
â”‚   URL: https://api.anthropic.com            â”‚
â”‚   é…ç½®: ~/.claude/settings.json             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€æ•°æ®ç»“æ„è®¾è®¡

### 4.1 ç±»å‹å®šä¹‰

```typescript
// packages/core/src/types.ts

/**
 * å·¥å…·ç±»å‹
 * - codex: Codex
 * - claudecode: Claude Codeï¼ˆæ³¨æ„ï¼šä¸æ˜¯ claudeï¼ï¼‰
 */
export type ToolType = 'codex' | 'claudecode'

/**
 * æœåŠ¡å•†é…ç½®
 * æ³¨æ„ï¼šä¸å†éœ€è¦ type å­—æ®µï¼Œå› ä¸ºé…ç½®æ–‡ä»¶å·²ç»åˆ†ç¦»
 */
export interface Provider {
  /** å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ï¼š{tool}-{timestamp}-{random}ï¼‰ */
  id: string
  /** æ˜¾ç¤ºåç§° */
  name: string
  /** API Base URL */
  baseUrl: string
  /** API Key */
  apiKey: string
  /** åˆ›å»ºæ—¶é—´ï¼ˆUnix timestampï¼‰ */
  createdAt: number
  /** æœ€åä½¿ç”¨æ—¶é—´ï¼ˆUnix timestampï¼Œå¯é€‰ï¼‰ */
  lastUsedAt?: number
}

/**
 * å•ä¸ªå·¥å…·çš„é…ç½®æ–‡ä»¶ç»“æ„
 */
export interface ToolConfig {
  /** æœåŠ¡å•†åˆ—è¡¨ */
  providers: Provider[]
  /** å½“å‰æ¿€æ´»çš„æœåŠ¡å•† ID */
  activeProviderId?: string
}

/**
 * é¢„è®¾æ¨¡æ¿ï¼ˆä¸åŒ…å« API Keyï¼‰
 */
export interface PresetTemplate {
  /** é¢„è®¾åç§° */
  name: string
  /** é»˜è®¤ Base URL */
  baseUrl: string
  /** æè¿° */
  description: string
}

/**
 * æ·»åŠ æœåŠ¡å•†çš„è¾“å…¥å‚æ•°
 */
export interface AddProviderInput {
  name: string
  baseUrl: string
  apiKey: string
}

/**
 * ç¼–è¾‘æœåŠ¡å•†çš„è¾“å…¥å‚æ•°
 */
export interface EditProviderInput {
  name?: string
  baseUrl?: string
  apiKey?: string
}
```

### 4.2 é…ç½®æ–‡ä»¶æ ¼å¼

#### Codex é…ç½®æ–‡ä»¶ï¼ˆ`~/.ccman/codex.json`ï¼‰

```json
{
  "providers": [
    {
      "id": "codex-1704614400000-a1b2c3",
      "name": "OpenAI",
      "baseUrl": "https://api.openai.com",
      "apiKey": "sk-xxx",
      "createdAt": 1704614400000,
      "lastUsedAt": 1704614500000
    },
    {
      "id": "codex-1704614500000-d4e5f6",
      "name": "Anthropic",
      "baseUrl": "https://api.anthropic.com",
      "apiKey": "sk-ant-yyy",
      "createdAt": 1704614500000
    }
  ],
  "activeProviderId": "codex-1704614400000-a1b2c3"
}
```

#### Claude Code é…ç½®æ–‡ä»¶ï¼ˆ`~/.ccman/claudecode.json`ï¼‰

```json
{
  "providers": [
    {
      "id": "claudecode-1704614600000-g7h8i9",
      "name": "Anthropic Official",
      "baseUrl": "https://api.anthropic.com",
      "apiKey": "sk-ant-zzz",
      "createdAt": 1704614600000,
      "lastUsedAt": 1704614700000
    },
    {
      "id": "claudecode-1704614700000-j1k2l3",
      "name": "AnyRouter",
      "baseUrl": "https://anyrouter.top",
      "apiKey": "sk-or-www",
      "createdAt": 1704614700000
    }
  ],
  "activeProviderId": "claudecode-1704614600000-g7h8i9"
}
```

---

## äº”ã€ç¯å¢ƒé…ç½®æ–¹æ¡ˆ

### 5.1 ç¯å¢ƒç±»å‹

```typescript
type Environment = 'production' | 'development' | 'test'
```

| ç¯å¢ƒ | NODE_ENV | è¯´æ˜ | ç”¨é€” |
|------|----------|------|------|
| **ç”Ÿäº§ç¯å¢ƒ** | `production`ï¼ˆé»˜è®¤ï¼‰ | æ­£å¼ä½¿ç”¨ | ç”¨æˆ·æ—¥å¸¸ä½¿ç”¨ |
| **å¼€å‘ç¯å¢ƒ** | `development` | å¼€å‘è°ƒè¯• | CLI/Desktop æ‰‹åŠ¨æµ‹è¯• |
| **æµ‹è¯•ç¯å¢ƒ** | `test` | è‡ªåŠ¨åŒ–æµ‹è¯• | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯• |

### 5.2 ç¯å¢ƒé…ç½®è¡¨

#### ç”Ÿäº§ç¯å¢ƒï¼ˆ`production`ï¼‰

| é…ç½®ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|---------|------|------|
| ccman é…ç½® | `~/.ccman/codex.json` | Codex æœåŠ¡å•†åˆ—è¡¨ |
| | `~/.ccman/claudecode.json` | Claude Code æœåŠ¡å•†åˆ—è¡¨ |
| Codex é…ç½® | `~/.codex/config.toml` | Codex å·¥å…·é…ç½® |
| | `~/.codex/auth.json` | Codex API Key |
| Claude é…ç½® | `~/.claude/settings.json` | Claude Code å·¥å…·é…ç½® |

#### å¼€å‘ç¯å¢ƒï¼ˆ`development`ï¼‰

| é…ç½®ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|---------|------|------|
| ccman é…ç½® | `$TMPDIR/ccman-dev/.ccman/codex.json` | å¼€å‘ç¯å¢ƒ Codex é…ç½® |
| | `$TMPDIR/ccman-dev/.ccman/claudecode.json` | å¼€å‘ç¯å¢ƒ Claude Code é…ç½® |
| Codex é…ç½® | `$TMPDIR/ccman-dev/.codex/config.toml` | å¼€å‘ç¯å¢ƒ Codex å·¥å…·é…ç½® |
| | `$TMPDIR/ccman-dev/.codex/auth.json` | å¼€å‘ç¯å¢ƒ Codex API Key |
| Claude é…ç½® | `$TMPDIR/ccman-dev/.claude/settings.json` | å¼€å‘ç¯å¢ƒ Claude Code é…ç½® |

**è¯´æ˜**ï¼š
- `$TMPDIR` åœ¨ macOS ä¸Šé€šå¸¸æ˜¯ `/var/folders/...`
- å¼€å‘ç¯å¢ƒä½¿ç”¨ç‹¬ç«‹ç›®å½•ï¼Œ**ä¸å½±å“æ­£å¼ç¯å¢ƒ**
- å¯ä»¥é€šè¿‡ `rm -rf $TMPDIR/ccman-dev` æ¸…ç†å¼€å‘æ•°æ®

#### æµ‹è¯•ç¯å¢ƒï¼ˆ`test`ï¼‰

| é…ç½®ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|---------|------|------|
| ccman é…ç½® | `$TMPDIR/ccman-test-{PID}/.ccman/codex.json` | æµ‹è¯•ç¯å¢ƒ Codex é…ç½® |
| | `$TMPDIR/ccman-test-{PID}/.ccman/claudecode.json` | æµ‹è¯•ç¯å¢ƒ Claude Code é…ç½® |
| Codex é…ç½® | `$TMPDIR/ccman-test-{PID}/.codex/config.toml` | æµ‹è¯•ç¯å¢ƒ Codex é…ç½® |
| | `$TMPDIR/ccman-test-{PID}/.codex/auth.json` | æµ‹è¯•ç¯å¢ƒ Codex API Key |
| Claude é…ç½® | `$TMPDIR/ccman-test-{PID}/.claude/settings.json` | æµ‹è¯•ç¯å¢ƒ Claude Code é…ç½® |

**è¯´æ˜**ï¼š
- æ¯ä¸ªæµ‹è¯•è¿›ç¨‹ä½¿ç”¨ç‹¬ç«‹ç›®å½•ï¼ˆåŸºäº PIDï¼‰
- æµ‹è¯•ç»“æŸåè‡ªåŠ¨æ¸…ç†ï¼ˆå¯é€‰ï¼‰
- **ç»ä¸å½±å“æ­£å¼ç¯å¢ƒ**

### 5.3 ç¯å¢ƒåˆ‡æ¢æ–¹å¼

#### æ–¹å¼ 1ï¼šé€šè¿‡ NODE_ENV ç¯å¢ƒå˜é‡

```bash
# ç”Ÿäº§ç¯å¢ƒï¼ˆé»˜è®¤ï¼‰
ccman cx add

# å¼€å‘ç¯å¢ƒ
NODE_ENV=development ccman cx add

# æµ‹è¯•ç¯å¢ƒï¼ˆä»…é™è‡ªåŠ¨åŒ–æµ‹è¯•ï¼‰
NODE_ENV=test pnpm test
```

#### æ–¹å¼ 2ï¼šé€šè¿‡ package.json è„šæœ¬

```json
{
  "scripts": {
    "dev": "NODE_ENV=development node packages/cli/dist/index.js",
    "test": "NODE_ENV=test vitest",
    "start": "NODE_ENV=production node packages/cli/dist/index.js"
  }
}
```

ä½¿ç”¨ï¼š
```bash
pnpm dev cx add        # å¼€å‘ç¯å¢ƒ
pnpm test              # æµ‹è¯•ç¯å¢ƒ
pnpm start cx add      # ç”Ÿäº§ç¯å¢ƒ
```

### 5.4 è·¯å¾„ç®¡ç†å®ç°

```typescript
// packages/core/src/paths.ts

import os from 'os'
import path from 'path'

/**
 * è·å–å½“å‰ç¯å¢ƒç±»å‹
 */
function getEnvironment(): 'production' | 'development' | 'test' {
  const env = process.env.NODE_ENV || 'production'

  if (env === 'test') return 'test'
  if (env === 'development') return 'development'
  return 'production'
}

/**
 * è·å–ç¯å¢ƒæ ¹ç›®å½•
 */
function getEnvRoot(): string {
  const env = getEnvironment()

  switch (env) {
    case 'production':
      // ç”Ÿäº§ç¯å¢ƒï¼šç”¨æˆ·ä¸»ç›®å½•
      return os.homedir()

    case 'development':
      // å¼€å‘ç¯å¢ƒï¼šä¸´æ—¶ç›®å½•/ccman-dev
      return path.join(os.tmpdir(), 'ccman-dev')

    case 'test':
      // æµ‹è¯•ç¯å¢ƒï¼šä¸´æ—¶ç›®å½•/ccman-test-{PID}
      return path.join(os.tmpdir(), `ccman-test-${process.pid}`)
  }
}

/**
 * è·å– ccman é…ç½®ç›®å½•
 * - production: ~/.ccman
 * - development: $TMPDIR/ccman-dev/.ccman
 * - test: $TMPDIR/ccman-test-{PID}/.ccman
 */
export function getCcmanDir(): string {
  return path.join(getEnvRoot(), '.ccman')
}

/**
 * è·å– Codex é…ç½®ç›®å½•
 * - production: ~/.codex
 * - development: $TMPDIR/ccman-dev/.codex
 * - test: $TMPDIR/ccman-test-{PID}/.codex
 */
export function getCodexDir(): string {
  return path.join(getEnvRoot(), '.codex')
}

/**
 * è·å– Claude Code é…ç½®ç›®å½•
 * - production: ~/.claude
 * - development: $TMPDIR/ccman-dev/.claude
 * - test: $TMPDIR/ccman-test-{PID}/.claude
 */
export function getClaudeDir(): string {
  return path.join(getEnvRoot(), '.claude')
}

/**
 * è·å– Codex é…ç½®æ–‡ä»¶è·¯å¾„
 */
export function getCodexConfigPath(): string {
  return path.join(getCcmanDir(), 'codex.json')
}

/**
 * è·å– Claude Code é…ç½®æ–‡ä»¶è·¯å¾„
 */
export function getClaudeCodeConfigPath(): string {
  return path.join(getCcmanDir(), 'claudecode.json')
}

/**
 * æ¸…ç†æµ‹è¯•ç¯å¢ƒç›®å½•ï¼ˆä»…æµ‹è¯•ç¯å¢ƒå¯ç”¨ï¼‰
 */
export function cleanupTestEnv(): void {
  const env = getEnvironment()

  if (env !== 'test') {
    throw new Error('cleanupTestEnv() can only be called in test environment')
  }

  const testRoot = getEnvRoot()
  const fs = require('fs')

  if (fs.existsSync(testRoot)) {
    fs.rmSync(testRoot, { recursive: true, force: true })
  }
}

/**
 * æ‰“å°å½“å‰ç¯å¢ƒä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
 */
export function printEnvInfo(): void {
  console.log('Environment:', getEnvironment())
  console.log('ccman dir:', getCcmanDir())
  console.log('Codex dir:', getCodexDir())
  console.log('Claude dir:', getClaudeDir())
}
```

### 5.5 ç¯å¢ƒå®‰å…¨æ£€æŸ¥

```typescript
// packages/core/src/utils/env-check.ts

import { getEnvironment, getCcmanDir } from '../paths'
import os from 'os'

/**
 * æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨çš„ç¯å¢ƒä¸­æ‰§è¡Œå±é™©æ“ä½œ
 */
export function checkSafeToModify(): void {
  const env = getEnvironment()
  const ccmanDir = getCcmanDir()
  const homeDir = os.homedir()

  // å¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä¸”é…ç½®ç›®å½•æ˜¯ä¸»ç›®å½•ä¸‹çš„ .ccman
  if (env === 'production' && ccmanDir === `${homeDir}/.ccman`) {
    // ç”Ÿäº§ç¯å¢ƒï¼Œå…è®¸ä¿®æ”¹
    return
  }

  // å¦‚æœåœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼Œä¸”é…ç½®ç›®å½•ä¸æ˜¯ä¸»ç›®å½•ä¸‹çš„
  if (env !== 'production' && !ccmanDir.startsWith(homeDir)) {
    // å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼Œå…è®¸ä¿®æ”¹
    return
  }

  // å…¶ä»–æƒ…å†µï¼ŒæŠ›å‡ºé”™è¯¯
  throw new Error(
    `Unsafe environment detected!\n` +
    `Environment: ${env}\n` +
    `Config dir: ${ccmanDir}\n` +
    `This may modify production files. Please check NODE_ENV.`
  )
}

/**
 * é˜²æ­¢åœ¨æµ‹è¯•ä¸­è¯¯åˆ ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶
 */
export function preventProductionModification(): void {
  const env = getEnvironment()
  const ccmanDir = getCcmanDir()
  const homeDir = os.homedir()

  // å¦‚æœé…ç½®ç›®å½•æŒ‡å‘ä¸»ç›®å½•ï¼Œä½†ç¯å¢ƒä¸æ˜¯ production
  if (ccmanDir.startsWith(homeDir) && env !== 'production') {
    throw new Error(
      `âŒ DANGER: Config directory points to home directory in ${env} environment!\n` +
      `This would modify production files.\n` +
      `Config dir: ${ccmanDir}\n` +
      `Environment: ${env}\n\n` +
      `Fix: Set NODE_ENV=${env} correctly.`
    )
  }
}
```

### 5.6 å¼€å‘ç¯å¢ƒæµ‹è¯•æµç¨‹

#### æ¸…ç†å¼€å‘ç¯å¢ƒæ•°æ®

```bash
# æŸ¥çœ‹å¼€å‘ç¯å¢ƒè·¯å¾„
NODE_ENV=development node -e "console.log(require('os').tmpdir() + '/ccman-dev')"

# æ¸…ç†å¼€å‘ç¯å¢ƒæ•°æ®
rm -rf $(node -e "console.log(require('os').tmpdir())")/ccman-dev

# æˆ–è€…ä½¿ç”¨è„šæœ¬
pnpm clean:dev
```

#### æ‰‹åŠ¨æµ‹è¯•

```bash
# 1. æ¸…ç†å¼€å‘ç¯å¢ƒ
rm -rf $TMPDIR/ccman-dev

# 2. è¿è¡Œ CLIï¼ˆå¼€å‘ç¯å¢ƒï¼‰
NODE_ENV=development pnpm dev cx add

# 3. æŸ¥çœ‹ç”Ÿæˆçš„é…ç½®
cat $TMPDIR/ccman-dev/.ccman/codex.json
cat $TMPDIR/ccman-dev/.codex/config.toml

# 4. ç¡®è®¤ä¸å½±å“ç”Ÿäº§ç¯å¢ƒ
cat ~/.ccman/codex.json  # ä¸åº”è¯¥è¢«ä¿®æ”¹
```

---

## å…­ã€æ¨¡å—è¯¦ç»†è®¾è®¡

### 6.1 Core Layer - tool-manager.ts

```typescript
// packages/core/src/tool-manager.ts

import { ToolType, Provider, AddProviderInput, EditProviderInput, ToolConfig } from './types'
import { getCodexConfigPath, getClaudeCodeConfigPath } from './paths'
import { readJSON, writeJSON, fileExists, ensureDir } from './utils/file'
import { writeCodexConfig } from './writers/codex'
import { writeClaudeCodeConfig } from './writers/claudecode'
import { CODEX_PRESETS } from './presets/codex'
import { CLAUDECODE_PRESETS } from './presets/claudecode'
import path from 'path'

/**
 * å·¥å…·ç®¡ç†å™¨æ¥å£
 */
export interface ToolManager {
  addProvider(input: AddProviderInput): Provider
  listProviders(): Provider[]
  getProvider(id: string): Provider
  switchProvider(id: string): void
  getCurrentProvider(): Provider | null
  updateProvider(id: string, updates: EditProviderInput): Provider
  removeProvider(id: string): void
  getPresets(): PresetTemplate[]
}

/**
 * åˆ›å»ºå·¥å…·ç®¡ç†å™¨ï¼ˆå·¥å‚å‡½æ•°ï¼‰
 */
function createToolManager(tool: ToolType): ToolManager {
  // é…ç½®æ–‡ä»¶è·¯å¾„
  const configPath = tool === 'codex'
    ? getCodexConfigPath()
    : getClaudeCodeConfigPath()

  // é¢„è®¾æœåŠ¡å•†
  const presets = tool === 'codex' ? CODEX_PRESETS : CLAUDECODE_PRESETS

  // åŠ è½½é…ç½®
  function loadConfig(): ToolConfig {
    if (!fileExists(configPath)) {
      const emptyConfig: ToolConfig = {
        providers: [],
        activeProviderId: undefined,
      }
      ensureDir(path.dirname(configPath))
      writeJSON(configPath, emptyConfig)
      return emptyConfig
    }

    return readJSON<ToolConfig>(configPath)
  }

  // ä¿å­˜é…ç½®
  function saveConfig(config: ToolConfig): void {
    writeJSON(configPath, config)
  }

  // ç”Ÿæˆå”¯ä¸€ ID
  function generateId(): string {
    const timestamp = Date.now()
    const random = Math.random().toString(36).substring(2, 8)
    return `${tool}-${timestamp}-${random}`
  }

  return {
    // æ·»åŠ æœåŠ¡å•†
    addProvider(input: AddProviderInput): Provider {
      const config = loadConfig()

      const provider: Provider = {
        id: generateId(),
        name: input.name,
        baseUrl: input.baseUrl,
        apiKey: input.apiKey,
        createdAt: Date.now(),
      }

      config.providers.push(provider)
      saveConfig(config)

      return provider
    },

    // åˆ—å‡ºæ‰€æœ‰æœåŠ¡å•†
    listProviders(): Provider[] {
      const config = loadConfig()
      return config.providers
    },

    // è·å–æœåŠ¡å•†
    getProvider(id: string): Provider {
      const config = loadConfig()
      const provider = config.providers.find(p => p.id === id)

      if (!provider) {
        throw new Error(`Provider not found: ${id}`)
      }

      return provider
    },

    // åˆ‡æ¢æœåŠ¡å•†
    switchProvider(id: string): void {
      const config = loadConfig()
      const provider = config.providers.find(p => p.id === id)

      if (!provider) {
        throw new Error(`Provider not found: ${id}`)
      }

      config.activeProviderId = id
      provider.lastUsedAt = Date.now()
      saveConfig(config)

      // å†™å…¥ç›®æ ‡å·¥å…·é…ç½®ï¼ˆè°ƒç”¨ writer å‡½æ•°ï¼‰
      if (tool === 'codex') {
        writeCodexConfig(provider)
      } else if (tool === 'claudecode') {
        writeClaudeCodeConfig(provider)
      }
    },

    // è·å–å½“å‰æœåŠ¡å•†
    getCurrentProvider(): Provider | null {
      const config = loadConfig()

      if (!config.activeProviderId) {
        return null
      }

      return config.providers.find(p => p.id === config.activeProviderId) || null
    },

    // æ›´æ–°æœåŠ¡å•†
    updateProvider(id: string, updates: EditProviderInput): Provider {
      const config = loadConfig()
      const provider = config.providers.find(p => p.id === id)

      if (!provider) {
        throw new Error(`Provider not found: ${id}`)
      }

      // æ›´æ–°å­—æ®µ
      if (updates.name !== undefined) provider.name = updates.name
      if (updates.baseUrl !== undefined) provider.baseUrl = updates.baseUrl
      if (updates.apiKey !== undefined) provider.apiKey = updates.apiKey

      saveConfig(config)

      // å¦‚æœæ˜¯å½“å‰æ¿€æ´»çš„æœåŠ¡å•†ï¼Œé‡æ–°å†™å…¥é…ç½®
      if (config.activeProviderId === id) {
        if (tool === 'codex') {
          writeCodexConfig(provider)
        } else if (tool === 'claudecode') {
          writeClaudeCodeConfig(provider)
        }
      }

      return provider
    },

    // åˆ é™¤æœåŠ¡å•†
    removeProvider(id: string): void {
      const config = loadConfig()
      const index = config.providers.findIndex(p => p.id === id)

      if (index === -1) {
        throw new Error(`Provider not found: ${id}`)
      }

      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æœåŠ¡å•†ï¼Œæ¸…é™¤æ¿€æ´»çŠ¶æ€
      if (config.activeProviderId === id) {
        config.activeProviderId = undefined
      }

      config.providers.splice(index, 1)
      saveConfig(config)
    },

    // è·å–é¢„è®¾æœåŠ¡å•†
    getPresets() {
      return presets
    }
  }
}

// å¯¼å‡ºä¸¤ä¸ªå®ä¾‹
export const codex = createToolManager('codex')
export const claudeCode = createToolManager('claudecode')
```

### 6.2 Writers Layer - codex.ts

```typescript
// packages/core/src/writers/codex.ts

import { Provider } from '../types'
import { getCodexDir } from '../paths'
import { ensureDir, fileExists } from '../utils/file'
import path from 'path'
import fs from 'fs'
import TOML from '@iarna/toml'

/**
 * å†™å…¥ Codex é…ç½®æ–‡ä»¶
 *
 * ç›®æ ‡æ–‡ä»¶ï¼š
 * - ~/.codex/config.toml
 * - ~/.codex/auth.json
 */
export function writeCodexConfig(provider: Provider): void {
  const codexDir = getCodexDir()
  ensureDir(codexDir)

  const configPath = path.join(codexDir, 'config.toml')
  const authPath = path.join(codexDir, 'auth.json')

  // 1. å†™å…¥ config.toml
  writeConfigToml(configPath, provider)

  // 2. å†™å…¥ auth.json
  writeAuthJson(authPath, provider)
}

/**
 * å†™å…¥ config.toml
 */
function writeConfigToml(configPath: string, provider: Provider): void {
  let config: any

  // è¯»å–ç°æœ‰é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (fileExists(configPath)) {
    const content = fs.readFileSync(configPath, 'utf-8')
    config = TOML.parse(content)
  } else {
    config = {}
  }

  // æ›´æ–°é…ç½®ï¼ˆé›¶ç ´åæ€§ï¼‰
  config.model_provider = provider.name

  if (!config.model_providers) {
    config.model_providers = {}
  }

  config.model_providers[provider.name] = {
    name: provider.name,
    base_url: provider.baseUrl,
    wire_api: 'responses',
    requires_openai_auth: true,
  }

  // å†™å…¥æ–‡ä»¶
  const tomlString = TOML.stringify(config)
  fs.writeFileSync(configPath, tomlString, 'utf-8')
}

/**
 * å†™å…¥ auth.json
 */
function writeAuthJson(authPath: string, provider: Provider): void {
  const auth = {
    OPENAI_API_KEY: provider.apiKey,
  }

  fs.writeFileSync(authPath, JSON.stringify(auth, null, 2), 'utf-8')
}
```

### 6.3 Writers Layer - claudecode.ts

```typescript
// packages/core/src/writers/claudecode.ts

import { Provider } from '../types'
import { getClaudeDir } from '../paths'
import { ensureDir, fileExists, readJSON, writeJSON } from '../utils/file'
import path from 'path'

/**
 * å†™å…¥ Claude Code é…ç½®æ–‡ä»¶
 *
 * ç›®æ ‡æ–‡ä»¶ï¼š
 * - ~/.claude/settings.json
 */
export function writeClaudeCodeConfig(provider: Provider): void {
  const claudeDir = getClaudeDir()
  ensureDir(claudeDir)

  const settingsPath = path.join(claudeDir, 'settings.json')

  let settings: any

  // è¯»å–ç°æœ‰é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (fileExists(settingsPath)) {
    settings = readJSON(settingsPath)
  } else {
    settings = {
      env: {},
      permissions: {
        allow: [],
        deny: [],
      },
    }
  }

  // æ›´æ–°é…ç½®ï¼ˆé›¶ç ´åæ€§ï¼‰
  if (!settings.env) {
    settings.env = {}
  }

  settings.env.ANTHROPIC_AUTH_TOKEN = provider.apiKey
  settings.env.ANTHROPIC_BASE_URL = provider.baseUrl

  // å†™å…¥æ–‡ä»¶
  writeJSON(settingsPath, settings)
}
```

### 6.4 Presets - codex.ts

```typescript
// packages/core/src/presets/codex.ts

import { PresetTemplate } from '../types'

export const CODEX_PRESETS: PresetTemplate[] = [
  {
    name: 'Anthropic Official',
    baseUrl: 'https://api.anthropic.com',
    description: 'Anthropic å®˜æ–¹ API',
  },
  {
    name: 'AnyRouter',
    baseUrl: 'https://anyrouter.top',
    description: 'AnyRouter API æœåŠ¡',
  },
  {
    name: 'PackyCode',
    baseUrl: 'https://api.packycode.com',
    description: 'PackyCode API æœåŠ¡',
  },
  {
    name: 'CoordCode',
    baseUrl: 'https://api.coordcode.com/api',
    description: 'CoordCode API æœåŠ¡',
  },
  {
    name: '88Code',
    baseUrl: 'https://www.88code.org/api',
    description: '88Code API æœåŠ¡',
  },
  {
    name: 'BigModel',
    baseUrl: 'https://open.bigmodel.cn/api/anthropic',
    description: 'æ™ºè°± BigModel API',
  },
  {
    name: 'ModelScope',
    baseUrl: 'https://api-inference.modelscope.cn/v1/chat/completions',
    description: 'é˜¿é‡Œäº‘ ModelScope API',
  },
]
```

### 6.5 Presets - claudecode.ts

```typescript
// packages/core/src/presets/claudecode.ts

import { PresetTemplate } from '../types'

export const CLAUDECODE_PRESETS: PresetTemplate[] = [
  {
    name: 'Anthropic Official',
    baseUrl: 'https://api.anthropic.com',
    description: 'Anthropic å®˜æ–¹ API',
  },
  {
    name: 'AnyRouter',
    baseUrl: 'https://anyrouter.top',
    description: 'AnyRouter API æœåŠ¡',
  },
  {
    name: 'PackyCode',
    baseUrl: 'https://api.packycode.com',
    description: 'PackyCode API æœåŠ¡',
  },
  {
    name: 'CoordCode',
    baseUrl: 'https://api.coordcode.com/api',
    description: 'CoordCode API æœåŠ¡',
  },
  {
    name: '88Code',
    baseUrl: 'https://www.88code.org/api',
    description: '88Code API æœåŠ¡',
  },
  {
    name: 'BigModel',
    baseUrl: 'https://open.bigmodel.cn/api/anthropic',
    description: 'æ™ºè°± BigModel API',
  },
  {
    name: 'ModelScope',
    baseUrl: 'https://api-inference.modelscope.cn/v1/chat/completions',
    description: 'é˜¿é‡Œäº‘ ModelScope API',
  },
]
```

---

## ä¸ƒã€å·¥ä½œæµç¨‹

### 7.1 æ·»åŠ æœåŠ¡å•†æµç¨‹

```
ç”¨æˆ·æ‰§è¡Œ: ccman cx add
  â†“
CLI Layer (commands/codex.ts)
  â”œâ”€â†’ 1. è¯¢é—®é…ç½®æ¥æºï¼ˆé¢„è®¾ or è‡ªå®šä¹‰ï¼‰
  â”œâ”€â†’ 2. å¦‚æœé€‰æ‹©é¢„è®¾ï¼š
  â”‚      â”œâ”€â†’ è°ƒç”¨ codex.getPresets()
  â”‚      â”œâ”€â†’ æ˜¾ç¤ºé¢„è®¾åˆ—è¡¨ï¼ˆåªæ˜¾ç¤º Codex çš„é¢„è®¾ï¼‰
  â”‚      â””â”€â†’ é€‰æ‹©é¢„è®¾ + è¾“å…¥ API Key
  â””â”€â†’ 3. è°ƒç”¨ codex.addProvider(input)
        â†“
Core Layer (tool-manager.ts)
  â”œâ”€â†’ 1. ç”Ÿæˆå”¯ä¸€ ID
  â”œâ”€â†’ 2. åˆ›å»º Provider å¯¹è±¡
  â”œâ”€â†’ 3. ä¿å­˜åˆ° ~/.ccman/codex.json
  â””â”€â†’ 4. è¿”å› Provider
        â†“
CLI Layer
  â”œâ”€â†’ 1. æ˜¾ç¤ºæ·»åŠ æˆåŠŸä¿¡æ¯
  â”œâ”€â†’ 2. è¯¢é—®æ˜¯å¦ç«‹å³åˆ‡æ¢
  â””â”€â†’ 3. å¦‚æœç¡®è®¤ï¼šè°ƒç”¨ codex.switchProvider(id)
        â†“
Core Layer (tool-manager.ts)
  â”œâ”€â†’ 1. æ›´æ–° activeProviderId
  â”œâ”€â†’ 2. æ›´æ–° lastUsedAt
  â”œâ”€â†’ 3. ä¿å­˜é…ç½®
  â””â”€â†’ 4. è°ƒç”¨ writeCodexConfig(provider)
        â†“
Writers Layer (writers/codex.ts)
  â”œâ”€â†’ 1. è¯»å– ~/.codex/config.tomlï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  â”œâ”€â†’ 2. æ›´æ–° model_provider å’Œ model_providers
  â”œâ”€â†’ 3. å†™å…¥ ~/.codex/config.toml
  â””â”€â†’ 4. å†™å…¥ ~/.codex/auth.json
```

### 7.2 åˆ‡æ¢æœåŠ¡å•†æµç¨‹

```
ç”¨æˆ·æ‰§è¡Œ: ccman cx use "OpenAI"
  â†“
CLI Layer (commands/codex.ts)
  â”œâ”€â†’ 1. è°ƒç”¨ codex.listProviders()
  â”œâ”€â†’ 2. æ ¹æ® name æŸ¥æ‰¾ Provider
  â””â”€â†’ 3. è°ƒç”¨ codex.switchProvider(id)
        â†“
Core Layer (tool-manager.ts)
  â”œâ”€â†’ 1. æ›´æ–° activeProviderId
  â”œâ”€â†’ 2. æ›´æ–° lastUsedAt
  â”œâ”€â†’ 3. ä¿å­˜åˆ° ~/.ccman/codex.json
  â””â”€â†’ 4. è°ƒç”¨ writeCodexConfig(provider)
        â†“
Writers Layer (writers/codex.ts)
  â”œâ”€â†’ 1. è¯»å– ~/.codex/config.toml
  â”œâ”€â†’ 2. æ›´æ–° model_provider = "OpenAI"
  â”œâ”€â†’ 3. æ›´æ–° model_providers["OpenAI"]
  â”œâ”€â†’ 4. å†™å…¥ ~/.codex/config.toml
  â””â”€â†’ 5. å†™å…¥ ~/.codex/auth.json
        â†“
CLI Layer
  â””â”€â†’ æ˜¾ç¤ºåˆ‡æ¢æˆåŠŸä¿¡æ¯
```

### 7.3 æŸ¥çœ‹çŠ¶æ€æµç¨‹

```
ç”¨æˆ·æ‰§è¡Œ: ccman status
  â†“
CLI Layer (commands/status.ts)
  â”œâ”€â†’ 1. è°ƒç”¨ codex.getCurrentProvider()
  â”œâ”€â†’ 2. è°ƒç”¨ claudeCode.getCurrentProvider()
  â””â”€â†’ 3. æ ¼å¼åŒ–æ˜¾ç¤ºä¸¤è€…çš„çŠ¶æ€
```

---

## å…«ã€ä»£ç ç¤ºä¾‹

### 8.1 CLI Layer - commands/codex.ts

```typescript
// packages/cli/src/commands/codex.ts

import { Command } from 'commander'
import { codex } from '@ccman/core'
import inquirer from 'inquirer'
import chalk from 'chalk'

export function codexCommand(program: Command): void {
  const codexCmd = program
    .command('cx')
    .description('ç®¡ç† Codex æœåŠ¡å•†')

  // ccman cx add
  codexCmd
    .command('add')
    .description('æ·»åŠ  Codex æœåŠ¡å•†')
    .action(async () => {
      console.log(chalk.bold('\nğŸ“ æ·»åŠ  Codex æœåŠ¡å•†\n'))

      const { usePreset } = await inquirer.prompt([{
        type: 'list',
        name: 'usePreset',
        message: 'é€‰æ‹©é…ç½®æ¥æºï¼š',
        choices: [
          { name: 'ğŸ“¦ ä½¿ç”¨é¢„ç½®æœåŠ¡å•†', value: true },
          { name: 'âœï¸  è‡ªå®šä¹‰é…ç½®', value: false },
        ],
      }])

      let input

      if (usePreset) {
        const presets = codex.getPresets()

        const { presetName } = await inquirer.prompt([{
          type: 'list',
          name: 'presetName',
          message: 'é€‰æ‹©é¢„ç½®æœåŠ¡å•†ï¼š',
          choices: presets.map(p => ({
            name: `${p.name} - ${p.description}`,
            value: p.name,
          })),
        }])

        const preset = presets.find(p => p.name === presetName)!
        const { apiKey } = await inquirer.prompt([{
          type: 'password',
          name: 'apiKey',
          message: 'è¾“å…¥ API å¯†é’¥ï¼š',
          mask: '*',
        }])

        input = {
          name: preset.name,
          baseUrl: preset.baseUrl,
          apiKey,
        }
      } else {
        // è‡ªå®šä¹‰é…ç½®...
      }

      const provider = codex.addProvider(input)

      console.log(chalk.green('\nâœ… æ·»åŠ æˆåŠŸ\n'))
      console.log(`  ${chalk.bold(provider.name)} ${chalk.blue('[Codex]')}`)
      console.log(`  ${chalk.gray(`ID: ${provider.id}`)}`)
      console.log(`  ${chalk.gray(`URL: ${provider.baseUrl}`)}`)

      // è¯¢é—®æ˜¯å¦ç«‹å³åˆ‡æ¢
      const { switchNow } = await inquirer.prompt([{
        type: 'confirm',
        name: 'switchNow',
        message: 'æ˜¯å¦ç«‹å³åˆ‡æ¢åˆ°æ­¤æœåŠ¡å•†ï¼Ÿ',
        default: true,
      }])

      if (switchNow) {
        codex.switchProvider(provider.id)
        console.log(chalk.green('\nâœ… å·²åˆ‡æ¢åˆ°æ–°æœåŠ¡å•†'))
        console.log(chalk.gray('é…ç½®å·²æ›´æ–°ï¼š~/.codex/config.toml'))
      }
    })

  // ccman cx list
  codexCmd
    .command('list')
    .alias('ls')
    .description('åˆ—å‡º Codex æœåŠ¡å•†')
    .action(() => {
      const providers = codex.listProviders()
      const current = codex.getCurrentProvider()

      if (providers.length === 0) {
        console.log(chalk.yellow('\nâš ï¸  æš‚æ— æœåŠ¡å•†'))
        console.log(chalk.blue('ğŸ’¡ æ·»åŠ æœåŠ¡å•†ï¼šccman cx add\n'))
        return
      }

      console.log(chalk.bold('\nğŸ“‹ Codex æœåŠ¡å•†åˆ—è¡¨ï¼š\n'))

      providers.forEach(provider => {
        const isCurrent = current?.id === provider.id
        const prefix = isCurrent ? chalk.green('â— ') : '  '
        const name = isCurrent ? chalk.green.bold(provider.name) : chalk.white(provider.name)

        console.log(`${prefix}${name}`)
        console.log(`  ${chalk.gray(`ID: ${provider.id}`)}`)
        console.log(`  ${chalk.gray(`URL: ${provider.baseUrl}`)}`)

        if (isCurrent) {
          console.log(`  ${chalk.green('âœ“ æ¿€æ´»ä¸­')}`)
        }

        console.log()
      })

      console.log(chalk.gray(`å…± ${providers.length} ä¸ªæœåŠ¡å•†\n`))
    })

  // ccman cx use
  codexCmd
    .command('use <name>')
    .description('åˆ‡æ¢ Codex æœåŠ¡å•†')
    .action((name: string) => {
      const providers = codex.listProviders()
      const provider = providers.find(p => p.name === name || p.id === name)

      if (!provider) {
        console.error(chalk.red(`\nâŒ æœåŠ¡å•†ä¸å­˜åœ¨: ${name}\n`))
        console.log(chalk.blue('ğŸ’¡ æŸ¥çœ‹æ‰€æœ‰æœåŠ¡å•†: ccman cx list\n'))
        process.exit(1)
      }

      codex.switchProvider(provider.id)

      console.log(chalk.green('\nâœ… åˆ‡æ¢æˆåŠŸ\n'))
      console.log(`  ${chalk.bold(provider.name)} ${chalk.blue('[Codex]')}`)
      console.log(chalk.gray('  é…ç½®å·²æ›´æ–°ï¼š~/.codex/config.toml\n'))
    })

  // ccman cx current
  codexCmd
    .command('current')
    .description('æŸ¥çœ‹å½“å‰ Codex æœåŠ¡å•†')
    .action(() => {
      const current = codex.getCurrentProvider()

      if (!current) {
        console.log(chalk.yellow('\nâš ï¸  æš‚æ— æ¿€æ´»çš„æœåŠ¡å•†'))
        console.log(chalk.blue('ğŸ’¡ åˆ‡æ¢æœåŠ¡å•†ï¼šccman cx use <name>\n'))
        return
      }

      console.log(chalk.bold('\nğŸ“ å½“å‰ Codex æœåŠ¡å•†ï¼š\n'))
      console.log(`  ${chalk.green.bold(current.name)}`)
      console.log(`  ${chalk.gray(`URL: ${current.baseUrl}`)}`)
      console.log()
    })
}
```

### 8.2 CLI Layer - commands/status.ts

```typescript
// packages/cli/src/commands/status.ts

import { Command } from 'commander'
import { codex, claudeCode } from '@ccman/core'
import chalk from 'chalk'

export function statusCommand(program: Command): void {
  program
    .command('status')
    .description('æŸ¥çœ‹ Codex å’Œ Claude Code çŠ¶æ€')
    .action(() => {
      const codexCurrent = codex.getCurrentProvider()
      const claudeCurrent = claudeCode.getCurrentProvider()

      console.log(chalk.bold('\nğŸ“Š å½“å‰çŠ¶æ€\n'))

      // Codex çŠ¶æ€
      console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”')
      console.log('â”‚ ' + chalk.blue.bold('Codex') + '                                       â”‚')

      if (codexCurrent) {
        console.log('â”‚   ' + chalk.green('â— ') + chalk.bold(codexCurrent.name.padEnd(40)) + 'â”‚')
        console.log('â”‚   ' + chalk.gray(`URL: ${codexCurrent.baseUrl}`.padEnd(43)) + 'â”‚')
        console.log('â”‚   ' + chalk.gray('é…ç½®: ~/.codex/config.toml'.padEnd(43)) + 'â”‚')
      } else {
        console.log('â”‚   ' + chalk.yellow('âš ï¸  æœªæ¿€æ´»'.padEnd(42)) + 'â”‚')
      }

      console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n')

      // Claude Code çŠ¶æ€
      console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”')
      console.log('â”‚ ' + chalk.magenta.bold('Claude Code') + '                              â”‚')

      if (claudeCurrent) {
        console.log('â”‚   ' + chalk.green('â— ') + chalk.bold(claudeCurrent.name.padEnd(40)) + 'â”‚')
        console.log('â”‚   ' + chalk.gray(`URL: ${claudeCurrent.baseUrl}`.padEnd(43)) + 'â”‚')
        console.log('â”‚   ' + chalk.gray('é…ç½®: ~/.claude/settings.json'.padEnd(43)) + 'â”‚')
      } else {
        console.log('â”‚   ' + chalk.yellow('âš ï¸  æœªæ¿€æ´»'.padEnd(42)) + 'â”‚')
      }

      console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n')
    })
}
```

---

## ä¹ã€æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

```typescript
// packages/core/__tests__/tool-manager.test.ts

import { describe, it, expect, beforeEach, afterEach } from 'vitest'
import { codex, claudeCode } from '../src/tool-manager'
import { cleanupTestEnv } from '../src/paths'

describe('ToolManager - Codex', () => {
  beforeEach(() => {
    // ç¡®ä¿åœ¨æµ‹è¯•ç¯å¢ƒ
    process.env.NODE_ENV = 'test'
  })

  afterEach(() => {
    // æ¸…ç†æµ‹è¯•ç¯å¢ƒ
    cleanupTestEnv()
  })

  it('should add provider with auto-generated id', () => {
    const provider = codex.addProvider({
      name: 'Test Provider',
      baseUrl: 'https://api.test.com',
      apiKey: 'sk-test',
    })

    expect(provider.id).toMatch(/^codex-\d+-[a-z0-9]+$/)
    expect(provider.name).toBe('Test Provider')
    expect(provider.createdAt).toBeGreaterThan(0)
  })

  it('should list providers', () => {
    codex.addProvider({
      name: 'Provider 1',
      baseUrl: 'https://api.test1.com',
      apiKey: 'sk-test1',
    })

    codex.addProvider({
      name: 'Provider 2',
      baseUrl: 'https://api.test2.com',
      apiKey: 'sk-test2',
    })

    const providers = codex.listProviders()

    expect(providers).toHaveLength(2)
    expect(providers[0].name).toBe('Provider 1')
    expect(providers[1].name).toBe('Provider 2')
  })

  it('should switch provider', () => {
    const provider = codex.addProvider({
      name: 'Test Provider',
      baseUrl: 'https://api.test.com',
      apiKey: 'sk-test',
    })

    codex.switchProvider(provider.id)

    const current = codex.getCurrentProvider()

    expect(current).not.toBeNull()
    expect(current!.id).toBe(provider.id)
    expect(current!.lastUsedAt).toBeGreaterThan(0)
  })
})
```

### 9.2 é›†æˆæµ‹è¯•

```typescript
// packages/core/__tests__/integration.test.ts

import { describe, it, expect, beforeEach, afterEach } from 'vitest'
import { codex } from '../src/tool-manager'
import { getCodexDir } from '../src/paths'
import { cleanupTestEnv } from '../src/paths'
import fs from 'fs'
import path from 'path'
import TOML from '@iarna/toml'

describe('Integration - Codex Config Writing', () => {
  beforeEach(() => {
    process.env.NODE_ENV = 'test'
  })

  afterEach(() => {
    cleanupTestEnv()
  })

  it('should write Codex config files when switching provider', () => {
    // æ·»åŠ æœåŠ¡å•†
    const provider = codex.addProvider({
      name: 'Test Provider',
      baseUrl: 'https://api.test.com',
      apiKey: 'sk-test-123',
    })

    // åˆ‡æ¢æœåŠ¡å•†
    codex.switchProvider(provider.id)

    // éªŒè¯ config.toml æ–‡ä»¶
    const codexDir = getCodexDir()
    const configPath = path.join(codexDir, 'config.toml')

    expect(fs.existsSync(configPath)).toBe(true)

    const configContent = fs.readFileSync(configPath, 'utf-8')
    const config = TOML.parse(configContent)

    expect(config.model_provider).toBe('Test Provider')
    expect(config.model_providers['Test Provider']).toEqual({
      name: 'Test Provider',
      base_url: 'https://api.test.com',
      wire_api: 'responses',
      requires_openai_auth: true,
    })

    // éªŒè¯ auth.json æ–‡ä»¶
    const authPath = path.join(codexDir, 'auth.json')

    expect(fs.existsSync(authPath)).toBe(true)

    const authContent = fs.readFileSync(authPath, 'utf-8')
    const auth = JSON.parse(authContent)

    expect(auth.OPENAI_API_KEY).toBe('sk-test-123')
  })
})
```

### 9.3 ç¯å¢ƒéš”ç¦»æµ‹è¯•

```typescript
// packages/core/__tests__/env-isolation.test.ts

import { describe, it, expect, beforeEach, afterEach } from 'vitest'
import { getCcmanDir, getCodexDir, getClaudeDir } from '../src/paths'
import os from 'os'

describe('Environment Isolation', () => {
  const originalEnv = process.env.NODE_ENV

  afterEach(() => {
    process.env.NODE_ENV = originalEnv
  })

  it('should use home directory in production', () => {
    process.env.NODE_ENV = 'production'

    const ccmanDir = getCcmanDir()
    const codexDir = getCodexDir()
    const claudeDir = getClaudeDir()

    expect(ccmanDir).toBe(`${os.homedir()}/.ccman`)
    expect(codexDir).toBe(`${os.homedir()}/.codex`)
    expect(claudeDir).toBe(`${os.homedir()}/.claude`)
  })

  it('should use temp directory in development', () => {
    process.env.NODE_ENV = 'development'

    const ccmanDir = getCcmanDir()
    const codexDir = getCodexDir()
    const claudeDir = getClaudeDir()

    expect(ccmanDir).toContain('/ccman-dev/.ccman')
    expect(codexDir).toContain('/ccman-dev/.codex')
    expect(claudeDir).toContain('/ccman-dev/.claude')

    expect(ccmanDir).not.toContain(os.homedir())
  })

  it('should use unique temp directory in test', () => {
    process.env.NODE_ENV = 'test'

    const ccmanDir = getCcmanDir()
    const codexDir = getCodexDir()
    const claudeDir = getClaudeDir()

    expect(ccmanDir).toContain(`/ccman-test-${process.pid}/.ccman`)
    expect(codexDir).toContain(`/ccman-test-${process.pid}/.codex`)
    expect(claudeDir).toContain(`/ccman-test-${process.pid}/.claude`)

    expect(ccmanDir).not.toContain(os.homedir())
  })
})
```

---

## åã€ä¸æ—§è®¾è®¡çš„å¯¹æ¯”

### 10.1 æ ¸å¿ƒå·®å¼‚

| ç»´åº¦ | æ—§è®¾è®¡ | æ–°è®¾è®¡ | æ”¹è¿› |
|------|--------|--------|------|
| **é…ç½®æ–‡ä»¶** | æ··åœ¨ä¸€èµ·ï¼ˆ`config.json`ï¼‰ | åˆ†ç¦»ï¼ˆ`codex.json` + `claudecode.json`ï¼‰ | âœ… æ¸…æ™°åˆ†ç¦» |
| **æ•°æ®ç»“æ„** | `providers: Provider[]`ï¼ˆå« typeï¼‰ | ä¸¤ä¸ªç‹¬ç«‹é…ç½®ï¼ˆæ—  typeï¼‰ | âœ… æ¶ˆé™¤åˆ¤æ–­ |
| **å‘½ä»¤ç»“æ„** | `ccman add`ï¼ˆä¸æ˜ç¡®ï¼‰ | `ccman cx add` / `ccman cc add` | âœ… æ˜ç¡®å·¥å…· |
| **é¢„è®¾æœåŠ¡å•†** | æ··åœ¨ä¸€èµ·ï¼Œç”¨åç¼€åŒºåˆ† | åˆ†ç¦»ï¼ˆ`CODEX_PRESETS` / `CLAUDECODE_PRESETS`ï¼‰ | âœ… ç¬¦åˆéœ€æ±‚ |
| **Core API** | `addProvider(input)`ï¼ˆéœ€ä¼  typeï¼‰ | `codex.addProvider(input)` | âœ… æ— éœ€ type |
| **ä»£ç å¤æ‚åº¦** | åˆ°å¤„éƒ½æ˜¯ `if (type === ...)` | å·¥å‚å‡½æ•°ï¼Œé›¶åˆ¤æ–­ | âœ… ä»£ç ç®€æ´ |
| **ç¯å¢ƒéš”ç¦»** | âŒ æ— ç¯å¢ƒéš”ç¦» | âœ… å¼€å‘/æµ‹è¯•/ç”Ÿäº§åˆ†ç¦» | âœ… ä¸å½±å“ç”Ÿäº§ |
| **ç”¨æˆ·ä½“éªŒ** | "å¼€ç›²ç›’" | æ¸…æ™°ã€æ˜ç¡® | âœ… å¿ƒæ™ºè´Ÿæ‹…ä½ |

### 10.2 ä»£ç é‡å¯¹æ¯”

| æ¨¡å— | æ—§è®¾è®¡ | æ–°è®¾è®¡ | å‡å°‘ |
|------|--------|--------|------|
| Core Layer | ~300 è¡Œ | ~200 è¡Œ | -33% |
| CLI Layer | ~400 è¡Œ | ~300 è¡Œ | -25% |
| **æ€»è®¡** | ~700 è¡Œ | ~500 è¡Œ | **-28%** |

### 10.3 æ¦‚å¿µå¤æ‚åº¦å¯¹æ¯”

| ç»´åº¦ | æ—§è®¾è®¡ | æ–°è®¾è®¡ |
|------|--------|--------|
| **æ ¸å¿ƒæ¦‚å¿µæ•°** | 5ï¼ˆConfig, Provider, type, Presets, Writersï¼‰ | 4ï¼ˆToolConfig, Provider, Presets, Writersï¼‰ |
| **ç”¨æˆ·éœ€è¦ç†è§£çš„æ¦‚å¿µ** | 3ï¼ˆå·¥å…·ã€typeã€æœåŠ¡å•†ï¼‰ | 2ï¼ˆå·¥å…·ã€æœåŠ¡å•†ï¼‰ |
| **CLI å‚æ•°** | 2ï¼ˆcommand, optionsï¼‰ | 3ï¼ˆtool, command, optionsï¼‰|

**è¯´æ˜**ï¼šè™½ç„¶ CLI å‚æ•°å¤šäº†ä¸€ä¸ª `tool`ï¼Œä½†ç”¨æˆ·å¿ƒæ™ºè´Ÿæ‹…æ›´ä½ï¼Œå› ä¸ºæ˜ç¡®çŸ¥é“åœ¨æ“ä½œå“ªä¸ªå·¥å…·ã€‚

---

## æ€»ç»“

### âœ… æ ¸å¿ƒä¼˜åŠ¿

1. **æ¶æ„æ¸…æ™°**ï¼šä¸‰å±‚æ¶æ„ï¼ˆCLI â†’ Core â†’ Writersï¼‰ï¼ŒèŒè´£å•ä¸€
2. **æ•°æ®åˆ†ç¦»**ï¼šCodex å’Œ Claude Code å®Œå…¨ç‹¬ç«‹
3. **ç¯å¢ƒéš”ç¦»**ï¼šå¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒåˆ†ç¦»ï¼Œä¸å½±å“æ­£å¼é…ç½®
4. **ç”¨æˆ·å‹å¥½**ï¼šå‘½ä»¤æ˜ç¡®ï¼ˆ`cx` vs `cc`ï¼‰ï¼Œé›¶æ­§ä¹‰
5. **ä»£ç ç®€æ´**ï¼šå‡½æ•°å¼å®ç°ï¼Œä»£ç é‡å‡å°‘ 28%
6. **æ˜“äºæµ‹è¯•**ï¼šç¯å¢ƒéš”ç¦» + Mock å‡½æ•°

### ğŸš€ å®æ–½è·¯å¾„

1. **Phase 1**ï¼šCore å±‚é‡æ„ï¼ˆpaths.ts + tool-manager.tsï¼‰
2. **Phase 2**ï¼šCLI å±‚é‡æ„ï¼ˆå‘½ä»¤ç»“æ„è°ƒæ•´ï¼‰
3. **Phase 3**ï¼šWriters å±‚é€‚é…ï¼ˆç¯å¢ƒæ„ŸçŸ¥ï¼‰
4. **Phase 4**ï¼šæµ‹è¯•å®Œå–„ï¼ˆå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•ï¼‰
5. **Phase 5**ï¼šæ–‡æ¡£æ›´æ–° + å‘å¸ƒ

**æ€»å·¥æ—¶ä¼°ç®—**ï¼š8-12 å°æ—¶

---

**ç‰ˆæœ¬å†å²**ï¼š
- v2.0 (2025-01-07): æœ€ç»ˆæ–¹æ¡ˆï¼Œå¢åŠ ç¯å¢ƒé…ç½®ã€å®Œå–„æ¶æ„è®¾è®¡
- v1.0 (2025-01-07): åˆå§‹æ¶æ„æ–¹æ¡ˆ
